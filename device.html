<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e293b">
    <title>Skyboard - Device Settings</title>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/css/sidebar.css">
</head>
<body>
    <!-- Hamburger menu for mobile -->
    <button class="hamburger" id="hamburger">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </button>

    <!-- Sidebar navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
            <span>Skyboard</span>
        </div>
        <nav class="sidebar-nav">
            <a href="/device.html" class="nav-item active">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Device
            </a>
            <a href="/airports.html" class="nav-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7"/>
                </svg>
                Airports
            </a>
            <a href="/weather.html" class="nav-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                </svg>
                Weather
            </a>
            <a href="/system.html" class="nav-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                </svg>
                System
            </a>
            <a href="/diagnostics.html" class="nav-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                Diagnostics
            </a>
        </nav>
    </aside>

    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main content -->
    <main class="main">
        <div class="page-header">
            <h1>Device Settings</h1>
            <p>Configure LED strip and network settings</p>
        </div>

        <!-- LED Strip Configuration Card -->
        <div class="card">
            <div class="card-header">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                LED Strip Configuration
            </div>
            <div class="card-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="numLeds">Number of LEDs</label>
                        <input type="number" id="numLeds" min="1" max="150" value="125">
                    </div>
                    <div class="form-group">
                        <label for="brightnessValue">Brightness</label>
                        <input type="number" id="brightnessValue" min="0" max="255" value="20">
                        <span class="form-hint">0-255</span>
                    </div>
                </div>
                <div class="quick-actions">
                    <button class="btn btn-primary" id="launchWizardBtn">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Launch LED Setup Wizard
                    </button>
                </div>
            </div>
        </div>

        <!-- Display Settings Card -->
        <div class="card">
            <div class="card-header">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                Display Settings
            </div>
            <div class="card-body">
                <!-- Master On/Off Toggle -->
                <div class="toggle-row">
                    <div class="toggle-label">
                        <span>LEDs Enabled</span>
                        <small>Master on/off control for all LEDs</small>
                    </div>
                    <div class="toggle" id="ledsEnabled"></div>
                </div>

                <div class="section-divider"></div>

                <!-- Auto-Brightness Section -->
                <div class="toggle-row">
                    <div class="toggle-label">
                        <span>Auto-Brightness</span>
                        <small>Adjust brightness based on ambient light (requires BH1750 sensor)</small>
                    </div>
                    <div class="toggle" id="autoBrightnessEnabled"></div>
                </div>

                <div id="autoBrightnessSettings" style="margin-top: 12px;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="brightnessMin">Minimum Brightness</label>
                            <input type="number" id="brightnessMin" min="1" max="255" value="10">
                            <span class="form-hint">Darkest setting (1-255)</span>
                        </div>
                        <div class="form-group">
                            <label for="brightnessMax">Maximum Brightness</label>
                            <input type="number" id="brightnessMax" min="1" max="255" value="255">
                            <span class="form-hint">Brightest setting (1-255)</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap; margin-top: 12px;">
                        <div id="sensorStatus" class="wifi-status" style="flex: 1; min-width: 200px;">
                            <div class="wifi-row">
                                <span>Sensor Status</span>
                                <span id="sensorAvailable">--</span>
                            </div>
                            <div class="wifi-row">
                                <span>Current Lux</span>
                                <span id="currentLux">--</span>
                            </div>
                            <div class="wifi-row">
                                <span>Target Brightness</span>
                                <span id="targetBrightness">--</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" id="testSensorBtn">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                            Test Sensor
                        </button>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Quiet Hours Section -->
                <div class="toggle-row">
                    <div class="toggle-label">
                        <span>Quiet Hours</span>
                        <small>Automatically turn off LEDs during scheduled times</small>
                    </div>
                    <div class="toggle" id="quietHoursEnabled"></div>
                </div>

                <div id="quietHoursSettings" style="margin-top: 12px;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="quietStartTime">Start Time</label>
                            <input type="time" id="quietStartTime" value="23:00">
                            <span class="form-hint">When to turn off</span>
                        </div>
                        <div class="form-group">
                            <label for="quietEndTime">End Time</label>
                            <input type="time" id="quietEndTime" value="06:00">
                            <span class="form-hint">When to turn back on</span>
                        </div>
                    </div>
                    <div id="quietHoursStatus" class="wifi-status" style="margin-top: 12px;">
                        <div class="wifi-row">
                            <span>Currently Active</span>
                            <span id="quietHoursActive">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Card -->
        <div class="card">
            <div class="card-header">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
                </svg>
                Network
            </div>
            <div class="card-body">
                <div class="toggle-row">
                    <div class="toggle-label">
                        <span>Enable mDNS</span>
                        <small>Allow access via .local domain</small>
                    </div>
                    <div class="toggle" id="useMDNS"></div>
                </div>

                <div class="form-grid" id="hostname-section">
                    <div class="form-group">
                        <label for="hostname">Hostname</label>
                        <input type="text" id="hostname" maxlength="32" value="skyboard">
                        <span class="form-hint">Access at: http://<span id="hostname-preview">skyboard</span>.local</span>
                    </div>
                </div>

                <div class="section-divider"></div>

                <div style="display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap;">
                    <div class="wifi-status" style="flex: 1; min-width: 240px;">
                        <div class="wifi-row">
                            <span>Status</span>
                            <span id="wifi-status"><span class="status-dot success"></span> Connected</span>
                        </div>
                        <div class="wifi-row">
                            <span>Network</span>
                            <span id="wifi-network">--</span>
                        </div>
                        <div class="wifi-row">
                            <span>IP Address</span>
                            <span id="wifi-ip">--</span>
                        </div>
                        <div class="wifi-row">
                            <span>Signal</span>
                            <span id="wifi-signal">-- dBm</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="changeNetworkBtn">Change Network</button>
                </div>
            </div>
        </div>

        <!-- Floating Save Bar -->
        <div class="save-bar" id="saveBar">
            <span class="save-bar-text">You have unsaved changes</span>
            <button class="btn btn-primary" id="saveChangesBtn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Save Changes
            </button>
        </div>
    </main>

    <!-- Toast notification container -->
    <div id="toast-container"></div>

    <!-- Loading Modal -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-modal">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading device settings...</div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        let config = null;

        // ==================== DIRTY STATE TRACKING ====================
        let hasUnsavedChanges = false;
        let initialFormState = null;

        function captureInitialState() {
            initialFormState = {
                numLeds: document.getElementById('numLeds').value,
                brightness: document.getElementById('brightnessValue').value,
                hostname: document.getElementById('hostname').value,
                useMDNS: document.getElementById('useMDNS').classList.contains('active'),
                ledsEnabled: document.getElementById('ledsEnabled').classList.contains('active'),
                autoBrightnessEnabled: document.getElementById('autoBrightnessEnabled').classList.contains('active'),
                brightnessMin: document.getElementById('brightnessMin').value,
                brightnessMax: document.getElementById('brightnessMax').value,
                quietHoursEnabled: document.getElementById('quietHoursEnabled').classList.contains('active'),
                quietStartTime: document.getElementById('quietStartTime').value,
                quietEndTime: document.getElementById('quietEndTime').value
            };
        }

        function checkForChanges() {
            if (!initialFormState) return;

            const current = {
                numLeds: document.getElementById('numLeds').value,
                brightness: document.getElementById('brightnessValue').value,
                hostname: document.getElementById('hostname').value,
                useMDNS: document.getElementById('useMDNS').classList.contains('active'),
                ledsEnabled: document.getElementById('ledsEnabled').classList.contains('active'),
                autoBrightnessEnabled: document.getElementById('autoBrightnessEnabled').classList.contains('active'),
                brightnessMin: document.getElementById('brightnessMin').value,
                brightnessMax: document.getElementById('brightnessMax').value,
                quietHoursEnabled: document.getElementById('quietHoursEnabled').classList.contains('active'),
                quietStartTime: document.getElementById('quietStartTime').value,
                quietEndTime: document.getElementById('quietEndTime').value
            };

            const changed = JSON.stringify(current) !== JSON.stringify(initialFormState);

            if (changed !== hasUnsavedChanges) {
                hasUnsavedChanges = changed;
                const saveBar = document.getElementById('saveBar');
                const main = document.querySelector('.main');

                if (hasUnsavedChanges) {
                    saveBar.classList.add('visible');
                    main.classList.add('has-save-bar');
                } else {
                    saveBar.classList.remove('visible');
                    main.classList.remove('has-save-bar');
                }
            }
        }

        // Warn on page leave with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes.';
            }
        });

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async () => {
            initLucideIcons();
            initEventListeners();

            // Load data and hide loading overlay when done
            try {
                await Promise.all([loadConfig(), loadSystemStatus(), loadDisplayStatus()]);
            } finally {
                hideLoading();
            }
        });

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 300);
            }
        }

        // ==================== LUCIDE ICONS ====================
        function initLucideIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            // Hamburger menu
            const hamburger = document.getElementById('hamburger');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            hamburger.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            });

            overlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            });

            // Toggle switches
            document.querySelectorAll('.toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                });
            });

            // Hostname preview
            const hostnameInput = document.getElementById('hostname');
            const hostnamePreview = document.getElementById('hostname-preview');
            hostnameInput.addEventListener('input', (e) => {
                hostnamePreview.textContent = e.target.value || 'skyboard';
            });

            // Save button
            document.getElementById('saveChangesBtn').addEventListener('click', saveDeviceSettings);

            // Launch wizard button
            document.getElementById('launchWizardBtn').addEventListener('click', () => {
                window.location.href = '/airports.html?wizard=1';
            });

            // Change network button (placeholder)
            document.getElementById('changeNetworkBtn').addEventListener('click', () => {
                showToast('WiFi network change not yet implemented', 'warning');
            });

            // Display settings toggles - visibility updates only
            // (generic toggle handler above already handles classList.toggle('active'))
            document.getElementById('autoBrightnessEnabled').addEventListener('click', updateAutoBrightnessVisibility);
            document.getElementById('quietHoursEnabled').addEventListener('click', updateQuietHoursVisibility);

            // Test sensor button
            document.getElementById('testSensorBtn').addEventListener('click', testLightSensor);

            // Track changes on all inputs
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', checkForChanges);
                input.addEventListener('change', checkForChanges);
            });

            // Track changes on toggles
            document.querySelectorAll('.toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    setTimeout(checkForChanges, 50); // Small delay for class to update
                });
            });
        }

        // ==================== DISPLAY SETTINGS HELPERS ====================
        function updateAutoBrightnessVisibility() {
            const enabled = document.getElementById('autoBrightnessEnabled').classList.contains('active');
            const settings = document.getElementById('autoBrightnessSettings');
            settings.style.opacity = enabled ? '1' : '0.5';
            settings.style.pointerEvents = enabled ? 'auto' : 'none';
        }

        function updateQuietHoursVisibility() {
            const enabled = document.getElementById('quietHoursEnabled').classList.contains('active');
            const settings = document.getElementById('quietHoursSettings');
            settings.style.opacity = enabled ? '1' : '0.5';
            settings.style.pointerEvents = enabled ? 'auto' : 'none';
        }

        async function testLightSensor() {
            const btn = document.getElementById('testSensorBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px;"></span> Testing...';

            try {
                const response = await fetch('/api/v1/light-sensor/test');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.detected) {
                    document.getElementById('sensorAvailable').innerHTML = '<span class="status-dot success"></span> Detected';
                    document.getElementById('currentLux').textContent = data.lux.toFixed(1) + ' lux';
                    showToast(`Sensor detected: ${data.lux.toFixed(1)} lux`, 'success');
                } else {
                    document.getElementById('sensorAvailable').innerHTML = '<span class="status-dot error"></span> Not Detected';
                    document.getElementById('currentLux').textContent = '--';
                    showToast('Light sensor not detected. Check wiring.', 'warning');
                }
            } catch (error) {
                console.error('Failed to test sensor:', error);
                document.getElementById('sensorAvailable').innerHTML = '<span class="status-dot error"></span> Error';
                showToast('Failed to test light sensor', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ==================== API FUNCTIONS ====================
        async function loadConfig() {
            try {
                const response = await fetch('/api/v1/config');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                config = await response.json();
                updateFormFromConfig();
            } catch (error) {
                console.error('Failed to load config:', error);
                showToast('Failed to load configuration', 'error');
            }
        }

        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/v1/system/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const status = await response.json();
                updateWiFiStatus(status);
            } catch (error) {
                console.error('Failed to load system status:', error);
                // Don't show toast for status load failure - it's non-critical
            }
        }

        async function loadDisplayStatus() {
            try {
                const response = await fetch('/api/v1/display');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const display = await response.json();
                updateDisplayStatus(display);
            } catch (error) {
                console.error('Failed to load display status:', error);
                // Non-critical, don't show toast
            }
        }

        function updateDisplayStatus(display) {
            if (!display) return;

            // Auto-brightness sensor info
            if (display.autoBrightness) {
                const ab = display.autoBrightness;
                document.getElementById('sensorAvailable').innerHTML = ab.sensorAvailable
                    ? '<span class="status-dot success"></span> Connected'
                    : '<span class="status-dot error"></span> Not detected';

                if (ab.sensorAvailable) {
                    document.getElementById('currentLux').textContent =
                        ab.currentLux !== undefined ? `${ab.currentLux.toFixed(1)} lux` : '--';
                    document.getElementById('targetBrightness').textContent =
                        ab.targetBrightness !== undefined ? ab.targetBrightness : '--';
                } else {
                    document.getElementById('currentLux').textContent = '--';
                    document.getElementById('targetBrightness').textContent = '--';
                }
            }

            // Quiet hours status
            if (display.quietHours) {
                document.getElementById('quietHoursActive').innerHTML = display.quietHours.currentlyActive
                    ? '<span class="status-dot warning"></span> Active (LEDs off)'
                    : '<span class="status-dot success"></span> Inactive';
            }
        }

        async function saveDeviceSettings() {
            try {
                // Collect device settings
                const devicePayload = {
                    numLeds: parseInt(document.getElementById('numLeds').value),
                    brightness: parseInt(document.getElementById('brightnessValue').value),
                    mdns_name: document.getElementById('hostname').value.trim()
                };

                // Validate device settings
                if (devicePayload.numLeds < 1 || devicePayload.numLeds > 150) {
                    showToast('Number of LEDs must be between 1 and 150', 'error');
                    return;
                }
                if (devicePayload.brightness < 0 || devicePayload.brightness > 255) {
                    showToast('Brightness must be between 0 and 255', 'error');
                    return;
                }

                // Save device settings
                const deviceResponse = await fetch('/api/v1/device', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(devicePayload)
                });
                if (!deviceResponse.ok) {
                    throw new Error(`Device settings failed: ${deviceResponse.status}`);
                }

                // Collect display settings
                const quietStart = document.getElementById('quietStartTime').value.split(':');
                const quietEnd = document.getElementById('quietEndTime').value.split(':');

                const displayPayload = {
                    leds_enabled: document.getElementById('ledsEnabled').classList.contains('active'),
                    auto_brightness_enabled: document.getElementById('autoBrightnessEnabled').classList.contains('active'),
                    brightness_min: parseInt(document.getElementById('brightnessMin').value),
                    brightness_max: parseInt(document.getElementById('brightnessMax').value),
                    quiet_hours_enabled: document.getElementById('quietHoursEnabled').classList.contains('active'),
                    quiet_start_hour: parseInt(quietStart[0]),
                    quiet_start_minute: parseInt(quietStart[1]),
                    quiet_end_hour: parseInt(quietEnd[0]),
                    quiet_end_minute: parseInt(quietEnd[1])
                };

                // Save display settings
                const displayResponse = await fetch('/api/v1/display-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(displayPayload)
                });
                if (!displayResponse.ok) {
                    throw new Error(`Display settings failed: ${displayResponse.status}`);
                }

                showToast('Settings saved successfully', 'success');

                // Reload to get latest state
                await Promise.all([loadConfig(), loadDisplayStatus()]);

                // Reset dirty state tracking
                captureInitialState();
                checkForChanges(); // This will hide the save bar
            } catch (error) {
                console.error('Failed to save settings:', error);
                showToast('Failed to save settings: ' + error.message, 'error');
            }
        }

        // ==================== UI UPDATE FUNCTIONS ====================
        function updateFormFromConfig() {
            if (!config) return;

            document.getElementById('numLeds').value = config.numLeds || 125;
            document.getElementById('brightnessValue').value = config.brightness || 20;
            document.getElementById('hostname').value = config.mdns_name || config.hostname || 'skyboard';
            document.getElementById('hostname-preview').textContent = config.mdns_name || config.hostname || 'skyboard';

            // mDNS is always enabled on firmware - default to true if not specified
            const mdnsToggle = document.getElementById('useMDNS');
            const mdnsEnabled = config.useMDNS !== false; // Default true
            if (mdnsEnabled) {
                mdnsToggle.classList.add('active');
            } else {
                mdnsToggle.classList.remove('active');
            }

            // Display settings
            const ledsEnabledToggle = document.getElementById('ledsEnabled');
            if (config.leds_enabled !== false) {
                ledsEnabledToggle.classList.add('active');
            } else {
                ledsEnabledToggle.classList.remove('active');
            }

            const autoBrightnessToggle = document.getElementById('autoBrightnessEnabled');
            if (config.auto_brightness_enabled) {
                autoBrightnessToggle.classList.add('active');
            } else {
                autoBrightnessToggle.classList.remove('active');
            }
            document.getElementById('brightnessMin').value = config.brightness_min || 10;
            document.getElementById('brightnessMax').value = config.brightness_max || 255;

            const quietHoursToggle = document.getElementById('quietHoursEnabled');
            if (config.quiet_hours_enabled) {
                quietHoursToggle.classList.add('active');
            } else {
                quietHoursToggle.classList.remove('active');
            }

            // Format time values for input[type="time"]
            const startHour = String(config.quiet_start_hour || 23).padStart(2, '0');
            const startMin = String(config.quiet_start_minute || 0).padStart(2, '0');
            const endHour = String(config.quiet_end_hour || 6).padStart(2, '0');
            const endMin = String(config.quiet_end_minute || 0).padStart(2, '0');
            document.getElementById('quietStartTime').value = `${startHour}:${startMin}`;
            document.getElementById('quietEndTime').value = `${endHour}:${endMin}`;

            // Update visibility based on toggle states
            updateAutoBrightnessVisibility();
            updateQuietHoursVisibility();

            // Capture initial state for dirty tracking
            captureInitialState();
        }

        function updateWiFiStatus(status) {
            if (!status) return;

            // Update WiFi network info
            if (status.wifi) {
                document.getElementById('wifi-network').textContent = status.wifi.ssid || '--';
                document.getElementById('wifi-ip').textContent = status.wifi.localIP || '--';
                document.getElementById('wifi-signal').textContent = status.wifi.rssi ? `${status.wifi.rssi} dBm` : '-- dBm';

                // Update status indicator
                const statusElement = document.getElementById('wifi-status');
                if (status.wifi.connected) {
                    statusElement.innerHTML = '<span class="status-dot success"></span> Connected';
                } else {
                    statusElement.innerHTML = '<span class="status-dot error"></span> Disconnected';
                }
            }
        }

        // ==================== TOAST NOTIFICATIONS ====================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${message}</span>
                <span class="toast-close">Ã—</span>
            `;

            container.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);

            // Auto-hide after 3 seconds
            const hideTimeout = setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);

            // Close button
            toast.querySelector('.toast-close').addEventListener('click', () => {
                clearTimeout(hideTimeout);
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            });
        }
    </script>
</body>
</html>

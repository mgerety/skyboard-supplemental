<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0066cc">
  <title>Skyboard Configuration</title>
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
</head>
<body>
  <header class="page-header">
    <h1>‚úàÔ∏è Skyboard Configuration</h1>
    <nav>
      <a href="/">Config</a>
      <a href="/diagnostics">Diagnostics</a>
    </nav>
  </header>

  <div class="container">
    <!-- Instructions -->
    <div class="card">
      <h2>Instructions</h2>
      <ul>
        <li><strong>Airport Codes:</strong> Type to search by ICAO code, airport name, or city</li>
        <li><strong>Legend Values:</strong> Use LIFR, IFR, MVFR, WVFR, or VFR for static color display</li>
        <li><strong>Skip LEDs:</strong> Enter "NULL" or "BLACK" to turn off</li>
        <li><strong>Changes save:</strong> Click "Save Configuration" when done</li>
      </ul>
    </div>

    <!-- Flight Category Legend -->
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background: var(--color-lifr)"></div>
        <span>LIFR</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: var(--color-ifr)"></div>
        <span>IFR</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: var(--color-mvfr)"></div>
        <span>MVFR</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: var(--color-wvfr)"></div>
        <span>WVFR (Windy)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: var(--color-vfr)"></div>
        <span>VFR</span>
      </div>
    </div>

    <!-- Settings -->
    <div class="card">
      <h2>Settings</h2>
      <div class="settings-grid">
        <div class="setting-row">
          <label for="numLeds">Number of LEDs:</label>
          <input type="number" id="numLeds" class="input max-w-120" min="5" max="150" value="80">
        </div>
        <div class="setting-row">
          <label for="brightness">Brightness (0-255):</label>
          <div class="flex gap-md items-center flex-1">
            <input type="range" id="brightness" class="flex-1 max-w-300" min="0" max="255" value="20">
            <input type="number" id="brightnessValue" class="input w-80" min="0" max="255" value="20">
          </div>
        </div>
        <div class="setting-row">
          <label for="updateInterval">Update Interval:</label>
          <div class="flex gap-sm items-center">
            <input type="number" id="updateInterval" class="input w-80" min="5" max="60" value="15">
            <span>minutes</span>
          </div>
        </div>
        <div class="setting-row">
          <label for="hostname">Hostname:</label>
          <div class="flex flex-col gap-xs">
            <input type="text" id="hostname" class="input max-w-250" maxlength="32" placeholder="led-sectional" pattern="[a-zA-Z0-9\-]+">
            <small class="text-muted">
              Access via: http://<span id="hostnamePreview" class="font-bold">led-sectional</span>.local
            </small>
          </div>
        </div>
        <div class="setting-row">
          <label>Enable mDNS:</label>
          <div class="flex items-center">
            <input type="checkbox" id="useMDNS" checked>
          </div>
        </div>
      </div>
    </div>

    <!-- LED Assignments -->
    <div class="card">
      <div class="flex justify-between items-center mb-md">
        <h2 class="m-0">LED Assignments</h2>
        <input type="text" id="searchBox" class="input max-w-300" placeholder="Search by LED or airport code...">
      </div>
      <table class="led-table">
        <thead>
          <tr>
            <th>LED</th>
            <th>Airport</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="ledTableBody">
          <!-- Populated by JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- Save Button -->
    <button id="saveBtn" class="btn btn-primary btn-block">
      üíæ Save Configuration
    </button>
  </div>

  <script>
    // Global state
    let currentConfig = {
      numLeds: 80,
      brightness: 20,
      updateIntervalMinutes: 15,
      hostname: 'led-sectional',
      useMDNS: true,
      airports: []
    };
    // Fallback inline airport database (used if GitHub fetch fails)
    let airportsDatabase = [
      { code: "LIFR", name: "Low IFR (Legend)", city: "Flight Category" },
      { code: "IFR", name: "IFR (Legend)", city: "Flight Category" },
      { code: "MVFR", name: "Marginal VFR (Legend)", city: "Flight Category" },
      { code: "WVFR", name: "Windy VFR (Legend)", city: "Flight Category" },
      { code: "VFR", name: "VFR (Legend)", city: "Flight Category" },
      { code: "NULL", name: "Off (No Assignment)", city: "Special" },
      { code: "BLACK", name: "Off (Black)", city: "Special" }
    ];
    let statusData = [];

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function() {
      // Load airport database from GitHub
      await loadAirportDatabase();

      // Load current config
      await loadConfig();

      // Load status indicators
      await loadStatus();

      // Auto-refresh status every 60 seconds
      setInterval(loadStatus, 60000);

      // Setup event listeners
      setupEventListeners();
    });

    // Load airport database from GitHub (live from CDN, not from ESP8266)
    async function loadAirportDatabase() {
      try {
        const response = await fetch('https://raw.githubusercontent.com/mgerety/skyboard-supplemental/main/data/airports.json');
        if (!response.ok) {
          console.warn('Failed to load airport database, manual entry only');
          return;
        }
        const githubAirports = await response.json();
        // Transform array format [code, name, city] to object format {code, name, city}
        const transformedAirports = githubAirports.map(a => ({
          code: a[0],
          name: a[1],
          city: a[2]
        }));
        // APPEND to existing fallback values, don't replace
        airportsDatabase = [...airportsDatabase, ...transformedAirports];
        console.log(`Loaded ${airportsDatabase.length} airports total`);
      } catch (error) {
        console.warn('Airport database unavailable:', error);
      }
    }

    // Load configuration from ESP8266
    async function loadConfig() {
      try {
        const response = await fetch('/config');
        if (!response.ok) throw new Error('Failed to load config');

        const data = await response.json();
        currentConfig = {
          numLeds: data.numLeds || 80,
          brightness: data.brightness || 20,
          updateIntervalMinutes: data.updateIntervalMinutes || 15,
          hostname: data.hostname || 'led-sectional',
          useMDNS: data.useMDNS !== false,
          airports: data.airports || []
        };

        // Populate form fields
        document.getElementById('numLeds').value = currentConfig.numLeds;
        document.getElementById('brightness').value = currentConfig.brightness;
        document.getElementById('brightnessValue').value = currentConfig.brightness;
        document.getElementById('updateInterval').value = currentConfig.updateIntervalMinutes;
        document.getElementById('hostname').value = currentConfig.hostname;
        document.getElementById('hostnamePreview').textContent = currentConfig.hostname;
        document.getElementById('useMDNS').checked = currentConfig.useMDNS;

        // Render LED table
        renderLEDTable();

      } catch (error) {
        showToast('Error loading configuration: ' + error.message, 'error');
      }
    }

    // Load LED status from ESP8266
    async function loadStatus() {
      try {
        const response = await fetch('/api/status');
        if (!response.ok) {
          console.warn('Status endpoint not available');
          return;
        }

        const data = await response.json();
        statusData = data.leds || [];  // Extract the "leds" array
        updateStatusIndicators();

      } catch (error) {
        console.warn('Failed to load status:', error);
      }
    }

    // Render LED table with autocomplete inputs
    function renderLEDTable() {
      const tbody = document.getElementById('ledTableBody');
      tbody.innerHTML = '';

      for (let i = 0; i < currentConfig.numLeds; i++) {
        const assignment = currentConfig.airports[i] || 'NULL';
        const status = statusData.find(s => s.index === i) || { wxValue: null, color: '#000000' };

        const tr = document.createElement('tr');

        // LED number
        const tdNum = document.createElement('td');
        tdNum.className = 'led-number';
        tdNum.textContent = i;
        tr.appendChild(tdNum);

        // Airport code (editable with autocomplete)
        const tdAirport = document.createElement('td');
        tdAirport.innerHTML = `
          <div class="airport-input-wrapper">
            <input type="text" class="airport-input" data-led="${i}" value="${assignment}"
                   placeholder="Type to search..." autocapitalize="characters">
            <div class="autocomplete-dropdown" data-led="${i}"></div>
          </div>
        `;
        tr.appendChild(tdAirport);

        // Status dot
        const tdStatus = document.createElement('td');
        const statusDot = document.createElement('span');
        statusDot.className = 'status-dot';
        statusDot.dataset.led = i;
        statusDot.style.backgroundColor = status.color;
        tdStatus.appendChild(statusDot);
        tr.appendChild(tdStatus);

        tbody.appendChild(tr);
      }

      // Add autocomplete event listeners
      document.querySelectorAll('.airport-input').forEach(input => {
        input.addEventListener('input', handleAutocompleteInput);
        input.addEventListener('focus', handleAutocompleteInput);
        input.addEventListener('blur', (e) => {
          setTimeout(() => hideAutocomplete(e.target.dataset.led), 200);
        });
      });
    }

    // Update status indicators
    function updateStatusIndicators() {
      statusData.forEach(item => {
        const dot = document.querySelector(`.status-dot[data-led="${item.index}"]`);
        if (dot) {
          dot.style.backgroundColor = item.color || '#000000';
        }
      });
    }

    // Handle autocomplete input
    function handleAutocompleteInput(e) {
      const input = e.target;
      const ledIndex = input.dataset.led;
      const query = input.value.trim().toUpperCase();

      // If empty, show all options (special values + some airports)
      let matches;
      if (query.length === 0) {
        matches = airportsDatabase.slice(0, 20);  // Show first 20 options
      } else {
        matches = searchAirports(query);
      }

      showAutocomplete(ledIndex, matches, input);
    }

    // Search airports
    function searchAirports(query) {
      const q = query.toLowerCase();

      // Filter from airportsDatabase (already includes special values + airports)
      const matches = airportsDatabase.filter(a =>
        a && a.code && a.name && a.city &&
        (a.code.toLowerCase().includes(q) ||
         a.name.toLowerCase().includes(q) ||
         a.city.toLowerCase().includes(q))
      );

      return matches.slice(0, 10);
    }

    // Show autocomplete dropdown
    function showAutocomplete(ledIndex, matches, inputEl) {
      const dropdown = document.querySelector(`.autocomplete-dropdown[data-led="${ledIndex}"]`);

      if (matches.length === 0) {
        dropdown.innerHTML = '<div class="autocomplete-no-results">No airports found</div>';
        dropdown.classList.add('show');
        return;
      }

      const query = inputEl.value.toUpperCase();
      dropdown.innerHTML = matches.map(a => {
        const displayName = a.name.length > 35 ? a.name.substring(0, 32) + '...' : a.name;
        return `<div class="autocomplete-item" onclick="selectAirport(${ledIndex}, '${a.code}')">
          <span class="autocomplete-code">${a.code}</span>
          <span class="autocomplete-name">${displayName}</span>
        </div>`;
      }).join('');

      dropdown.classList.add('show');
    }

    // Hide autocomplete dropdown
    function hideAutocomplete(ledIndex) {
      const dropdown = document.querySelector(`.autocomplete-dropdown[data-led="${ledIndex}"]`);
      if (dropdown) {
        dropdown.classList.remove('show');
      }
    }

    // Select airport from autocomplete
    function selectAirport(ledIndex, code) {
      currentConfig.airports[ledIndex] = code;
      const input = document.querySelector(`.airport-input[data-led="${ledIndex}"]`);
      if (input) {
        input.value = code;
      }
      hideAutocomplete(ledIndex);
    }

    // Setup event listeners
    function setupEventListeners() {
      // Hostname preview
      document.getElementById('hostname').addEventListener('input', (e) => {
        document.getElementById('hostnamePreview').textContent = e.target.value || 'led-sectional';
      });

      // Brightness slider sync
      const brightnessSlider = document.getElementById('brightness');
      const brightnessValue = document.getElementById('brightnessValue');

      brightnessSlider.addEventListener('input', (e) => {
        brightnessValue.value = e.target.value;
      });

      brightnessValue.addEventListener('input', (e) => {
        let val = parseInt(e.target.value);
        if (isNaN(val)) val = 0;
        if (val < 0) val = 0;
        if (val > 255) val = 255;
        brightnessSlider.value = val;
        brightnessValue.value = val;
      });

      // Number of LEDs change
      document.getElementById('numLeds').addEventListener('change', (e) => {
        const newNum = parseInt(e.target.value);
        if (newNum >= 5 && newNum <= 150 && newNum !== currentConfig.numLeds) {
          currentConfig.numLeds = newNum;
          renderLEDTable();
        }
      });

      // Search box filtering
      document.getElementById('searchBox').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#ledTableBody tr');

        rows.forEach(row => {
          const ledNum = row.querySelector('.led-number').textContent;
          const airportInput = row.querySelector('.airport-input');
          const airportCode = airportInput ? airportInput.value.toLowerCase() : '';

          if (ledNum.includes(query) || airportCode.includes(query)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });

      // Save button
      document.getElementById('saveBtn').addEventListener('click', saveConfiguration);
    }

    // Save configuration
    async function saveConfiguration() {
      const saveBtn = document.getElementById('saveBtn');

      // Gather form data
      const numLeds = parseInt(document.getElementById('numLeds').value);
      const brightness = parseInt(document.getElementById('brightness').value);
      const updateIntervalMinutes = parseInt(document.getElementById('updateInterval').value);
      const hostname = document.getElementById('hostname').value.trim() || 'led-sectional';
      const useMDNS = document.getElementById('useMDNS').checked;

      // Validation
      if (numLeds < 5 || numLeds > 150) {
        showToast('Number of LEDs must be between 5 and 150', 'error');
        return;
      }

      if (brightness < 0 || brightness > 255) {
        showToast('Brightness must be between 0 and 255', 'error');
        return;
      }

      if (updateIntervalMinutes < 5 || updateIntervalMinutes > 60) {
        showToast('Update interval must be between 5 and 60 minutes', 'error');
        return;
      }

      // Hostname validation
      if (!/^[a-zA-Z0-9-]+$/.test(hostname)) {
        showToast('Hostname can only contain letters, numbers, and hyphens', 'error');
        return;
      }

      if (hostname.length > 32) {
        showToast('Hostname must be 32 characters or less', 'error');
        return;
      }

      if (hostname.startsWith('-') || hostname.endsWith('-')) {
        showToast('Hostname cannot start or end with a hyphen', 'error');
        return;
      }

      // Gather airport assignments
      const airports = [];
      for (let i = 0; i < numLeds; i++) {
        const input = document.querySelector(`.airport-input[data-led="${i}"]`);
        airports.push(input ? input.value.toUpperCase() : 'NULL');
      }

      const config = {
        numLeds,
        brightness,
        updateIntervalMinutes,
        hostname,
        useMDNS,
        airports
      };

      // Show loading state
      saveBtn.disabled = true;
      saveBtn.textContent = 'üíæ Saving...';

      try {
        const response = await fetch('/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || 'Failed to save configuration');
        }

        // Check for hostname change warning
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          const data = await response.json();
          if (data.hostnameChanged) {
            showToast('‚ö†Ô∏è ' + data.message + ' New URL: http://' + hostname + '.local', 'warning', 8000);
          } else {
            showToast('Configuration saved successfully!', 'success');
          }
        } else {
          showToast('Configuration saved successfully!', 'success');
        }

        // Update current config
        currentConfig = config;

      } catch (error) {
        showToast('Error saving configuration: ' + error.message, 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save Configuration';
      }
    }

    // Show toast notification (simple implementation without component library)
    function showToast(message, type = 'info', duration = 5000) {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 16px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        max-width: 300px;
        z-index: 10000;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#0066cc'};
        color: white;
        font-size: 14px;
      `;

      document.body.appendChild(toast);

      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, duration);
    }
  </script>
</body>
</html>

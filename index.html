<!DOCTYPE html>
<!-- Skyboard Web Interface Version: 132 -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1e3a8a">
  <title>Skyboard Configuration</title>
  <!-- Lucide Icons CDN (fallback to local if offline) -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="/js/icons.js"></script>
  <style>
    /* ==================================================
     * MODERN SKYBOARD DESIGN SYSTEM v2.0
     * Story 1.4B: Modernize Configuration Page
     * Reference: design-demo-modern-v5.html
     * ================================================== */

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Light Theme - Modern Design */
      --bg-gradient-start: #1e3a8a;
      --bg-gradient-end: #0c4a6e;
      --bg-body: linear-gradient(135deg, #1e3a8a 0%, #0c4a6e 100%);
      --card-bg: #f8f9fa;
      --card-shadow: rgba(0, 0, 0, 0.08);
      --card-hover-shadow: rgba(0, 0, 0, 0.12);
      --text-primary: #1a1a1a;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --border-color: #dee2e6;
      --input-bg: #ffffff;
      --input-border: #dee2e6;
      --navbar-bg: rgba(255, 255, 255, 0.95);
      --navbar-shadow: rgba(0, 0, 0, 0.08);
      --table-hover: #e9ecef;
      --accent-primary: #1e40af;
      --accent-secondary: #0369a1;
      --warning: #f59e0b;
      --warning-bg: #fef3c7;
      --warning-border: #fbbf24;
      --success: #28a745;
      --error: #dc3545;

      /* Flight Category Colors (Fixed) */
      --color-lifr: #FF00FF;
      --color-ifr: #FF0000;
      --color-mvfr: #0000FF;
      --color-wvfr: #FFFF00;
      --color-vfr: #00FF00;
    }

    [data-theme="dark"] {
      /* Dark Theme */
      --bg-gradient-start: #0f172a;
      --bg-gradient-end: #1e293b;
      --bg-body: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --card-bg: #1e293b;
      --card-shadow: rgba(0, 0, 0, 0.3);
      --card-hover-shadow: rgba(0, 0, 0, 0.4);
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border-color: #334155;
      --input-bg: #0f172a;
      --input-border: #334155;
      --navbar-bg: rgba(30, 41, 59, 0.95);
      --navbar-shadow: rgba(0, 0, 0, 0.3);
      --table-hover: #0f172a;
      --accent-primary: #3b82f6;
      --accent-secondary: #0ea5e9;
      --warning: #f59e0b;
      --warning-bg: #422006;
      --warning-border: #f59e0b;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Inter', sans-serif;
      background: var(--bg-body);
      min-height: 100vh;
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    /* NAVIGATION BAR */
    .navbar {
      background: var(--navbar-bg);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px var(--navbar-shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .navbar-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-primary);
      text-decoration: none;
    }

    .navbar-brand svg {
      width: 28px;
      height: 28px;
    }

    .navbar-menu {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .nav-link {
      padding: 8px 20px;
      border-radius: 8px;
      text-decoration: none;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 15px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-link svg {
      width: 18px;
      height: 18px;
    }

    .nav-link:hover {
      background: var(--input-bg);
      color: var(--accent-primary);
    }

    .nav-link.active {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
    }

    .theme-toggle {
      background: var(--input-bg);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      margin-left: 12px;
    }

    .theme-toggle:hover {
      border-color: var(--accent-primary);
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
      color: var(--text-secondary);
    }

    .hamburger {
      display: none;
      flex-direction: column;
      gap: 5px;
      cursor: pointer;
      padding: 8px;
    }

    .hamburger span {
      width: 24px;
      height: 3px;
      background: var(--text-secondary);
      border-radius: 2px;
      transition: all 0.3s;
    }

    /* MOBILE MENU */
    @media (max-width: 768px) {
      .navbar-menu {
        position: fixed;
        top: 64px;
        left: 0;
        right: 0;
        background: var(--navbar-bg);
        flex-direction: column;
        padding: 20px;
        gap: 12px;
        box-shadow: 0 8px 20px var(--navbar-shadow);
        transform: translateY(-120%);
        transition: transform 0.3s;
      }

      .navbar-menu.open {
        transform: translateY(0);
      }

      .hamburger {
        display: flex;
      }

      .nav-link {
        width: 100%;
        justify-content: center;
      }

      .theme-toggle {
        margin-left: 0;
        width: 100%;
        justify-content: center;
      }
    }

    /* MAIN CONTENT */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .page-header {
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 32px;
      font-weight: 700;
      color: white;
      margin-bottom: 8px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .page-title svg {
      width: 36px;
      height: 36px;
    }

    .page-subtitle {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.9);
    }

    /* COMPACT LEGEND */
    .compact-legend {
      display: flex;
      gap: 16px;
      padding: 12px 16px;
      background: var(--input-bg);
      border-radius: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
      border: 1px solid var(--border-color);
    }

    .compact-legend-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .compact-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .compact-legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .compact-legend-item span {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* CARDS */
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px var(--card-shadow);
      transition: all 0.3s ease;
      border: 1px solid var(--border-color);
    }

    .card:hover {
      box-shadow: 0 8px 30px var(--card-hover-shadow);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border-color);
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
    }

    .card-title svg {
      width: 24px;
      height: 24px;
      color: var(--accent-primary);
    }

    .card-header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .badge {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .card-description {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    /* FORM ELEMENTS */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-label svg {
      width: 16px;
      height: 16px;
    }

    .form-input {
      background: var(--input-bg);
      border: 2px solid var(--input-border);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 15px;
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
    }

    .form-input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--border-color);
    }

    /* SEARCH BOX WITH ICON */
    .search-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 350px;
      width: 100%;
    }

    @media (max-width: 768px) {
      .search-wrapper {
        max-width: 100%;
      }
    }

    .search-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .search-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-input-wrapper svg {
      position: absolute;
      left: 16px;
      width: 18px;
      height: 18px;
      color: var(--text-muted);
      pointer-events: none;
    }

    .search-input-wrapper input {
      padding-left: 44px;
      width: 100%;
    }

    .form-help {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* TOGGLE SWITCH */
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border-color);
      transition: 0.3s;
      border-radius: 28px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* TABLE */
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 0 0 1px var(--border-color);
      background: var(--input-bg);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      color: white;
    }

    th {
      padding: 16px 20px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    tbody tr {
      transition: all 0.15s;
    }

    tbody tr:hover {
      background: var(--table-hover);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .led-number {
      font-weight: 700;
      color: var(--accent-primary);
      font-size: 15px;
      font-family: 'Courier New', monospace;
    }

    .status-dot {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* TABLE INPUT - WITH VALIDATION STATES */
    .table-input-wrapper {
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
    }

    .table-input, .airport-input {
      background: var(--card-bg);
      border: 2px solid var(--input-border);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      width: 100%;
      transition: all 0.2s;
      font-family: 'Courier New', monospace;
      text-transform: uppercase;
      font-weight: 600;
      color: var(--text-primary);
    }

    .table-input:focus, .airport-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }

    /* WARNING STATE - INLINE VALIDATION */
    .table-input.warning, .airport-input.warning {
      background: var(--warning-bg);
      border-color: var(--warning-border);
      border-width: 2px;
    }

    .table-input.warning:focus, .airport-input.warning:focus {
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.15);
    }

    .validation-message {
      font-size: 12px;
      color: var(--warning);
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }

    .validation-message svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    /* AUTOCOMPLETE DROPDOWN */
    .airport-input-wrapper {
      position: relative;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .autocomplete-dropdown.show {
      display: block;
    }

    .autocomplete-item {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      gap: 12px;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      min-height: 44px;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover {
      background: var(--table-hover);
    }

    .autocomplete-item.selected {
      background-color: var(--accent-primary);
      color: white;
    }

    .autocomplete-item.selected:hover {
      background-color: var(--accent-primary);
    }

    .autocomplete-code {
      min-width: 60px;
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    .autocomplete-name {
      color: var(--text-muted);
      font-size: 12px;
    }

    .autocomplete-item.selected .autocomplete-name {
      color: rgba(255, 255, 255, 0.9);
    }

    .autocomplete-no-results {
      padding: 16px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* BUTTONS */
    .btn {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(30, 64, 175, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 12px;
    }

    .btn svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(30, 64, 175, 0.5);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-block {
      width: 100%;
      justify-content: center;
    }

    .btn-secondary {
      background: var(--input-bg);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 10px;
      box-shadow: none;
      display: inline-flex;
      align-items: center;
      gap: 12px;
    }

    .btn-secondary svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .btn-secondary:hover {
      border-color: var(--accent-primary);
      background: var(--accent-primary);
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
    }

    .btn-success {
      background: var(--success);
      box-shadow: 0 4px 16px rgba(40, 167, 69, 0.4);
    }

    .btn-success:hover {
      box-shadow: 0 8px 24px rgba(40, 167, 69, 0.5);
    }

    .btn-ghost {
      background-color: transparent;
      color: var(--text-muted);
      border: 2px solid var(--border-color);
      box-shadow: none;
    }

    .btn-ghost:hover {
      background-color: var(--card-bg);
      color: var(--text-primary);
      transform: none;
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-box {
      position: relative;
      background-color: var(--card-bg);
      padding: 28px;
      border-radius: 16px;
      box-shadow: 0 8px 30px var(--card-hover-shadow);
      max-width: 500px;
      width: calc(100% - 40px);
      animation: slideUp 0.3s;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-box h2 {
      margin-bottom: 16px;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .wizard-modal-description {
      margin: 16px 0;
      color: var(--text-primary);
      font-size: 15px;
      line-height: 1.6;
    }

    .wizard-modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 24px;
    }

    /* TOAST NOTIFICATIONS */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      max-width: 400px;
      width: calc(100% - 40px);
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      padding-right: 48px;
      box-shadow: 0 8px 24px var(--card-hover-shadow);
      opacity: 0;
      transition: all 0.3s;
      z-index: 2000;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.error {
      border-left: 4px solid var(--error);
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.info {
      border-left: 4px solid var(--accent-primary);
    }

    .toast.warning {
      border-left: 4px solid var(--warning);
    }

    .toast-title {
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .toast-message {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .toast-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      line-height: 1;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .toast-close:hover {
      color: var(--text-primary);
      background: var(--border-color);
      border-radius: 4px;
    }

    /* LOADING OVERLAY */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: white;
      font-size: 16px;
      margin-top: 16px;
      text-align: center;
    }

    /* WIZARD STYLES */
    .wizard-container {
      padding: 24px;
      background-color: var(--input-bg);
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .wizard-instructions {
      padding: 16px;
      background-color: rgba(30, 64, 175, 0.1);
      border-left: 4px solid var(--accent-primary);
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .wizard-instructions p {
      margin: 8px 0;
      color: var(--text-primary);
    }

    .wizard-instructions p:first-child {
      font-size: 18px;
      font-weight: 700;
      margin-top: 0;
    }

    .wizard-instructions p:last-child {
      margin-bottom: 0;
    }

    .wizard-rows {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }

    .wizard-row {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      transition: border-color 0.2s;
    }

    .wizard-row:focus-within {
      border-color: var(--accent-primary);
    }

    .wizard-led-label {
      font-weight: 700;
      min-width: 80px;
      color: var(--text-primary);
    }

    .wizard-input {
      flex: 1;
      min-width: 200px;
    }

    .wizard-next-btn {
      padding: 12px 24px;
      background-color: var(--accent-primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
      min-width: 100px;
      transition: all 0.2s;
    }

    .wizard-next-btn:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .wizard-next-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .wizard-buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 24px;
    }

    /* RESPONSIVE - MOBILE */
    @media (max-width: 600px) {
      .wizard-row {
        flex-direction: column;
        align-items: stretch;
      }

      .wizard-led-label {
        text-align: center;
        min-width: auto;
      }

      .wizard-input,
      .wizard-next-btn {
        width: 100%;
      }

      .wizard-buttons {
        flex-direction: column;
      }

      .wizard-modal-buttons {
        flex-direction: column;
      }

      .autocomplete-item {
        min-height: 48px;
        padding: 12px 16px;
      }

      .btn {
        min-height: 48px;
      }
    }

    /* UTILITY CLASSES */
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-sm { gap: 8px; }
    .gap-md { gap: 16px; }
    .mb-md { margin-bottom: 16px; }
    .text-muted { color: var(--text-muted); }
    .font-bold { font-weight: 700; }
    .w-80 { width: 80px; }
    .max-w-300 { max-width: 300px; }

    /* WiFi Configuration Styles */
    .wifi-info-card {
      background: var(--input-bg);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .wifi-info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .wifi-info-row:last-child {
      border-bottom: none;
    }

    .wifi-info-label {
      font-weight: 600;
      color: var(--text-muted);
    }

    .wifi-info-value {
      color: var(--text-primary);
      font-family: monospace;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--text-muted);
      cursor: pointer;
      width: 32px;
      height: 32px;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 2px solid var(--border-color);
      text-align: right;
    }

    /* Network scanning */
    .network-scanning {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Network list */
    .network-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .network-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .network-item:hover {
      border-color: var(--accent-primary);
      background: var(--input-bg);
    }

    .network-item.selected {
      border-color: var(--accent-primary);
      background: var(--accent-primary);
      color: white;
    }

    .network-ssid {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .network-rssi {
      font-size: 12px;
      color: var(--text-muted);
    }

    .network-item.selected .network-rssi {
      color: rgba(255, 255, 255, 0.8);
    }

    .network-credentials {
      margin-top: 24px;
    }

    /* Password input with toggle */
    .password-input-group {
      position: relative;
      display: flex;
      align-items: center;
    }

    .password-input-group input {
      flex: 1;
      padding-right: 48px;
    }

    .password-toggle {
      position: absolute;
      right: 12px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      padding: 4px;
      display: flex;
      align-items: center;
    }

    .password-toggle:hover {
      color: var(--text-primary);
    }

    .test-result {
      margin-left: 12px;
      font-weight: 600;
    }

    .test-result.success {
      color: var(--success);
    }

    .test-result.error {
      color: var(--error);
    }
  </style>
</head>
<body>
  <!-- NAVIGATION BAR -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="/" class="navbar-brand">
        <i data-lucide="plane"></i>
        <span>Skyboard</span>
      </a>
      <div class="hamburger" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <div class="navbar-menu" id="navMenu">
        <a href="/" class="nav-link active">
          <i data-lucide="settings"></i>
          Configuration
        </a>
        <a href="/diagnostics" class="nav-link">
          <i data-lucide="activity"></i>
          Diagnostics
        </a>
        <a href="/files" class="nav-link">
          <i data-lucide="folder"></i>
          Files
        </a>
        <button class="theme-toggle" onclick="toggleTheme()">
          <i data-lucide="sun" id="themeIcon"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">
        <i data-lucide="sliders"></i>
        LED Configuration
      </h1>
      <p class="page-subtitle">Configure your aviation weather LED sectional chart</p>
    </div>

    <!-- SETTINGS CARD -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i data-lucide="settings-2"></i>
          Settings
        </h2>
      </div>
      <p class="card-description">Configure LED strip parameters and network settings</p>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Number of LEDs</label>
          <input type="number" id="numLeds" class="form-input" min="1" max="150" value="80">
        </div>
        <div class="form-group">
          <label class="form-label">Brightness (0-255)</label>
          <input type="number" id="brightnessValue" class="form-input" min="0" max="255" value="20">
        </div>
        <div class="form-group">
          <label class="form-label">Update Interval (minutes)</label>
          <input type="number" id="updateInterval" class="form-input" min="5" max="1440" value="15">
          <small class="form-text text-muted">How often to check for weather updates (5-1440 minutes)</small>
        </div>
      </div>

      <hr style="border: none; border-top: 2px solid var(--border-color); margin: 24px 0;">

      <!-- Estimated Weather Settings -->
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">
            <i data-lucide="cloud"></i>
            Enable Estimated Weather
          </label>
          <div class="checkbox-wrapper">
            <label class="toggle-switch">
              <input type="checkbox" id="useEstimatedWeather">
              <span class="toggle-slider"></span>
            </label>
            <span class="text-muted" style="font-size: 14px;">Use backup sources for airports without METAR</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i data-lucide="lightbulb"></i>
            Pulse Estimated Weather LEDs
          </label>
          <div class="checkbox-wrapper">
            <label class="toggle-switch">
              <input type="checkbox" id="pulseEstimatedWeather">
              <span class="toggle-slider"></span>
            </label>
            <span class="text-muted" style="font-size: 14px;">Gently pulse LEDs showing estimated data</span>
          </div>
        </div>
      </div>

      <hr style="border: none; border-top: 2px solid var(--border-color); margin: 24px 0;">

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">
            <i data-lucide="wifi"></i>
            Enable mDNS
          </label>
          <div class="checkbox-wrapper">
            <label class="toggle-switch">
              <input type="checkbox" id="useMDNS" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="text-muted" style="font-size: 14px;">Allow access via .local domain</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i data-lucide="link"></i>
            Hostname
          </label>
          <input type="text" id="hostname" class="form-input" value="skyboard" maxlength="32" pattern="[a-zA-Z0-9\-]+">
          <div class="form-help">
            Access at: <strong>http://<span id="hostnamePreview">skyboard</span>.local</strong>
          </div>
        </div>

        <!-- WiFi Configuration -->
        <div class="form-group">
          <label class="form-label">
            <i data-lucide="wifi" style="width: 16px; height: 16px;"></i>
            WiFi Configuration
          </label>

          <!-- Current Connection Info -->
          <div id="wifiCurrentInfo" class="wifi-info-card">
            <div class="wifi-info-row">
              <span class="wifi-info-label">Network:</span>
              <span id="wifiCurrentSSID" class="wifi-info-value">Not connected</span>
            </div>
            <div class="wifi-info-row">
              <span class="wifi-info-label">IP Address:</span>
              <span id="wifiCurrentIP" class="wifi-info-value">--</span>
            </div>
            <div class="wifi-info-row">
              <span class="wifi-info-label">Signal Strength:</span>
              <span id="wifiCurrentRSSI" class="wifi-info-value">--</span>
            </div>
            <div class="wifi-info-row">
              <span class="wifi-info-label">MAC Address:</span>
              <span id="wifiCurrentMAC" class="wifi-info-value">--</span>
            </div>
          </div>

          <button type="button" class="btn btn-secondary" id="changeNetworkBtn" onclick="showNetworkSelector()">
            <i data-lucide="refresh-cw"></i>
            Change Network
          </button>
        </div>

        <!-- Network Selection Modal (hidden by default) -->
        <div id="networkSelectorModal" class="modal hidden">
          <div class="modal-content">
            <div class="modal-header">
              <h3>Select WiFi Network</h3>
              <button class="modal-close" onclick="hideNetworkSelector()">&times;</button>
            </div>

            <div class="modal-body">
              <!-- Scanning indicator -->
              <div id="networkScanning" class="network-scanning">
                <div class="spinner"></div>
                <p>Scanning for networks...</p>
              </div>

              <!-- Network list -->
              <div id="networkList" class="network-list hidden"></div>

              <!-- Selected network credentials -->
              <div id="networkCredentials" class="network-credentials hidden">
                <div class="form-group">
                  <label class="form-label">Network Name (SSID)</label>
                  <input type="text" id="selectedSSID" class="form-input" readonly>
                </div>

                <div class="form-group">
                  <label class="form-label">Password</label>
                  <div class="password-input-group">
                    <input type="password" id="wifiPassword" class="form-input" placeholder="Enter password">
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">
                      <i data-lucide="eye" id="passwordToggleIcon"></i>
                    </button>
                  </div>
                </div>

                <div class="form-group">
                  <button type="button" class="btn btn-secondary" onclick="testWiFiConnection()">
                    <i data-lucide="check-circle"></i>
                    Test Connection
                  </button>
                  <span id="testResult" class="test-result"></span>
                </div>

                <div class="button-group">
                  <button type="button" class="btn btn-primary" id="saveNetworkBtn" onclick="saveWiFiConfig()" disabled>
                    <i data-lucide="save"></i>
                    Save & Reboot
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="hideNetworkSelector()">
                    <i data-lucide="x"></i>
                    Cancel
                  </button>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary btn-sm" onclick="refreshNetworkScan()">
                <i data-lucide="refresh-cw"></i>
                Refresh List
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LED ASSIGNMENTS -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i data-lucide="map-pin"></i>
          LED Assignments
        </h2>
        <div class="card-header-actions">
          <span class="badge"><span id="ledCountBadge">0</span> configured</span>
          <button id="startWizardBtn" class="btn-secondary">
            <i data-lucide="wand-2"></i>
            Setup Wizard
          </button>
        </div>
      </div>

      <!-- COMPACT LEGEND -->
      <div class="compact-legend">
        <span class="compact-legend-label">Legend:</span>
        <div class="compact-legend-item">
          <div class="compact-legend-color" style="background: #FF00FF;"></div>
          <span>LIFR</span>
        </div>
        <div class="compact-legend-item">
          <div class="compact-legend-color" style="background: #FF0000;"></div>
          <span>IFR</span>
        </div>
        <div class="compact-legend-item">
          <div class="compact-legend-color" style="background: #0000FF;"></div>
          <span>MVFR</span>
        </div>
        <div class="compact-legend-item">
          <div class="compact-legend-color" style="background: #FFFF00;"></div>
          <span>WVFR</span>
        </div>
        <div class="compact-legend-item">
          <div class="compact-legend-color" style="background: #00FF00;"></div>
          <span>VFR</span>
        </div>
      </div>

      <!-- WIZARD CONTAINER (hidden by default) -->
      <div id="wizardContainer" class="wizard-container" style="display: none;">
        <div class="wizard-instructions">
          <p>LED Setup Wizard</p>
          <p>This wizard will help you identify each LED. The current LED will blink ORANGE. Previous LEDs will be GREEN. You can edit ANY textbox at ANY time. Click 'Next' to add the next LED.</p>
        </div>

        <div id="wizardRows" class="wizard-rows">
          <!-- Progressive LED rows will be added here by JavaScript -->
        </div>

        <div class="wizard-buttons">
          <button id="wizardSaveBtn" class="btn btn-success">
            <i data-lucide="save"></i>
            Save Configuration
          </button>
        </div>
      </div>

      <!-- MANUAL LED TABLE (shown when wizard is not active) -->
      <div id="manualLedConfig">
        <div class="flex justify-between items-center mb-md gap-md" style="flex-wrap: wrap;">
          <!-- Search Box -->
          <div class="search-wrapper">
            <label for="searchBox" class="search-label">Filter LEDs</label>
            <div class="search-input-wrapper">
              <i data-lucide="search"></i>
              <input type="text" id="searchBox" class="form-input" placeholder="Search by LED or airport code...">
            </div>
          </div>

          <div class="flex gap-sm items-center">
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
            <button id="importCsvBtn" class="btn-secondary">
              <i data-lucide="file-text"></i>
              Import CSV
            </button>
            <button id="exportCsvBtn" class="btn-secondary">
              <i data-lucide="download"></i>
              Download CSV
            </button>
          </div>
        </div>

        <p class="card-description">Assign airport codes to each LED. Use Tab to move between fields, Enter to save and advance.</p>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>LED</th>
                <th>Airport Code</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="ledTableBody">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SAVE BUTTON -->
    <button id="saveBtn" class="btn btn-block">
      <i data-lucide="save"></i>
      Save Configuration
    </button>
  </div>

  <!-- WIZARD START MODAL -->
  <div id="wizardStartModal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
      <h2>Start LED Setup Wizard</h2>
      <p class="wizard-modal-description" id="wizardModalLedCount">
        You currently have <strong>0 LEDs</strong> configured.
      </p>
      <div class="wizard-modal-buttons">
        <button id="wizardStartScratchBtn" class="btn btn-secondary">
          Start from Scratch
        </button>
        <button id="wizardContinueBtn" class="btn">
          Continue from Existing (<span id="wizardContinueLedCount">0</span> LEDs)
        </button>
        <button id="wizardCancelBtn" class="btn btn-ghost">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- TOAST NOTIFICATION -->
  <div id="toast" class="toast">
    <button class="toast-close" onclick="hideToast()" aria-label="Close notification">&times;</button>
    <div class="toast-title" id="toastTitle"></div>
    <div class="toast-message" id="toastMessage"></div>
  </div>

  <script>

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }

    // Global state
    let currentConfig = {
      numLeds: 80,
      brightness: 20,
      updateIntervalMinutes: 15,
      hostname: 'skyboard',
      useMDNS: true,
      airports: []
    };

    let airportsDatabase = [
      { code: "LIFR", name: "Low IFR (Legend)", city: "Flight Category" },
      { code: "IFR", name: "IFR (Legend)", city: "Flight Category" },
      { code: "MVFR", name: "Marginal VFR (Legend)", city: "Flight Category" },
      { code: "WVFR", name: "Windy VFR (Legend)", city: "Flight Category" },
      { code: "VFR", name: "VFR (Legend)", city: "Flight Category" },
      { code: "NONE", name: "Off (No Assignment)", city: "Special" },
      { code: "BLACK", name: "Off (Black)", city: "Special" }
    ];

    let statusData = [];
    let wizardActive = false;
    let wizardState = {
      numLeds: 0,
      currentIndex: 0,
      airports: [],
      brightness: 20
    };
    let cachedConfigForWizard = null;
    let toastTimeoutId = null;

    const WIZARD_STATE_KEY = 'skyboard_wizard_state';
    const WIZARD_STATE_TIMESTAMP_KEY = 'skyboard_wizard_timestamp';

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function() {
      showLoadingIndicator('Loading configuration...');

      try {
        await loadAirportDatabase();
        await loadConfig();
        await loadStatus();
        setInterval(loadStatus, 60000);
        setupEventListeners();
        setTimeout(() => checkForCrashedWizardSession(), 500);
      } finally {
        hideLoadingIndicator();
      }

      // Initialize Lucide icons after content is loaded
      lucide.createIcons();
    });

    // Load airport database
    async function loadAirportDatabase() {
      try {
        // Load from GitHub CDN (not stored locally on ESP32 - too large at ~951KB)
        const response = await fetch('https://raw.githubusercontent.com/mgerety/skyboard-supplemental/main/data/airports.json');
        if (!response.ok) {
          console.warn('Failed to load airport database, using fallback');
          return;
        }
        const airportsFromESP = await response.json();
        const transformedAirports = airportsFromESP.map(a => ({
          code: a[0],
          name: a[1],
          city: a[2],
          state: a[3]
        }));
        airportsDatabase = [...airportsDatabase, ...transformedAirports];
        console.log(`Loaded ${airportsDatabase.length} airports`);
      } catch (error) {
        console.warn('Airport database unavailable:', error);
      }
    }

    // Load configuration
    async function loadConfig() {
      try {
        const response = await fetch('/api/v1/config');
        if (!response.ok) throw new Error('Failed to load config');

        const data = await response.json();

        // Transform airports from array-of-objects to string array
        // ESP32 API returns: [{ledIndex: 0, airportCode: "KSFO"}, ...]
        // We need: ["KSFO", "KMRY", ...]
        const airportsArray = Array(data.numLeds || 80).fill('NONE');
        if (data.airports && Array.isArray(data.airports)) {
          data.airports.forEach(item => {
            if (item.ledIndex >= 0 && item.ledIndex < airportsArray.length) {
              airportsArray[item.ledIndex] = item.airportCode || 'NONE';
            }
          });
        }

        currentConfig = {
          numLeds: data.numLeds || 80,
          brightness: data.brightness || 20,
          updateIntervalMinutes: data.updateIntervalMinutes || 15,
          hostname: data.hostname || 'skyboard',
          useMDNS: data.useMDNS !== false,
          useEstimatedWeather: data.useEstimatedWeather !== false,
          pulseEstimatedWeather: data.pulseEstimatedWeather !== false,
          airports: airportsArray
        };

        document.getElementById('numLeds').value = currentConfig.numLeds;
        document.getElementById('brightnessValue').value = currentConfig.brightness;
        document.getElementById('updateInterval').value = currentConfig.updateIntervalMinutes;
        document.getElementById('hostname').value = currentConfig.hostname;
        document.getElementById('hostnamePreview').textContent = currentConfig.hostname;
        document.getElementById('useMDNS').checked = currentConfig.useMDNS;
        document.getElementById('useEstimatedWeather').checked = currentConfig.useEstimatedWeather;
        document.getElementById('pulseEstimatedWeather').checked = currentConfig.pulseEstimatedWeather;

        renderLEDTable();
      } catch (error) {
        showToast('Error loading configuration: ' + error.message, 'error');
      }
    }

    // Load LED status
    async function loadStatus() {
      try {
        const response = await fetch('/api/v1/weather');
        if (!response.ok) {
          console.warn('Status endpoint not available');
          return;
        }

        const data = await response.json();
        // V1 API returns array directly, not wrapped in {leds: [...]}
        statusData = Array.isArray(data) ? data : [];
        updateStatusIndicators();
      } catch (error) {
        console.warn('Failed to load status:', error);
      }
    }

    // Get color from flight category
    function getColorFromFlightCategory(assignment, wxValue) {
      const legendValues = ['LIFR', 'IFR', 'MVFR', 'WVFR', 'VFR'];
      if (legendValues.includes(assignment)) {
        switch(assignment) {
          case 'LIFR': return '#FF00FF';
          case 'IFR':  return '#FF0000';
          case 'MVFR': return '#0000FF';
          case 'WVFR': return '#FFFF00';
          case 'VFR':  return '#00FF00';
        }
      }

      if (assignment === 'NONE' || assignment === 'BLACK' || !wxValue) {
        return '#000000';
      }

      switch(wxValue) {
        case 'LIFR': return '#FF00FF';
        case 'IFR':  return '#FF0000';
        case 'MVFR': return '#0000FF';
        case 'WVFR': return '#FFFF00';
        case 'VFR':  return '#00FF00';
        case 'Pending': return '#FFA500';
        case '-':    return '#000000';
        default:     return '#888888';
      }
    }

    // Render LED table
    function renderLEDTable() {
      const tbody = document.getElementById('ledTableBody');
      tbody.innerHTML = '';

      for (let i = 0; i < currentConfig.numLeds; i++) {
        const assignment = currentConfig.airports[i] || 'NONE';
        // Display "NONE" instead of "NULL" for user-facing UI
        const displayValue = (assignment === 'NONE' || assignment === 'BLACK') ? 'NONE' : assignment;
        const status = statusData.find(s => s.index === i) || { wxValue: null, color: '#000000' };

        const tr = document.createElement('tr');

        const tdNum = document.createElement('td');
        tdNum.className = 'led-number';
        tdNum.textContent = i;
        tr.appendChild(tdNum);

        const tdAirport = document.createElement('td');
        tdAirport.innerHTML = `
          <div class="airport-input-wrapper">
            <input type="text"
                   class="airport-input"
                   data-led="${i}"
                   value="${displayValue}"
                   placeholder="Type to search..."
                   autocapitalize="characters"
                   aria-label="LED ${i} airport code"
                   aria-autocomplete="list"
                   aria-controls="autocomplete-dropdown-${i}"
                   role="combobox"
                   aria-expanded="false">
            <div class="autocomplete-dropdown"
                 data-led="${i}"
                 id="autocomplete-dropdown-${i}"
                 role="listbox"
                 aria-expanded="false"></div>
          </div>
        `;
        tr.appendChild(tdAirport);

        const tdStatus = document.createElement('td');
        const statusDot = document.createElement('span');
        statusDot.className = 'status-dot';
        statusDot.dataset.led = i;
        // Use actual color from firmware (server provides it)
        statusDot.style.backgroundColor = status?.color || '#000000';
        tdStatus.appendChild(statusDot);
        tr.appendChild(tdStatus);

        tbody.appendChild(tr);
      }

      document.querySelectorAll('.airport-input').forEach(input => {
        input.addEventListener('input', handleAutocompleteInput);
        input.addEventListener('focus', handleAutocompleteInput);
        input.addEventListener('blur', (e) => {
          setTimeout(() => hideAutocomplete(e.target.dataset.led), 200);
        });
        input.addEventListener('keydown', handleKeyboardNavigation);
      });

      // Update badge count
      const configuredCount = currentConfig.airports.filter(a => a && a !== 'NONE' && a !== '').length;
      document.getElementById('ledCountBadge').textContent = configuredCount;

      // Reinitialize Lucide icons for dynamically added content
      lucide.createIcons();
    }

    // Update status indicators
    function updateStatusIndicators() {
      statusData.forEach(item => {
        const dot = document.querySelector(`.status-dot[data-led="${item.ledNumber}"]`);
        if (dot) {
          // Use actual color from firmware (server provides it)
          dot.style.backgroundColor = item.color || '#000000';
        }
      });
    }

    // Handle autocomplete input
    function handleAutocompleteInput(e) {
      const input = e.target;
      const ledIndex = input.dataset.led;
      const query = input.value.trim().toUpperCase();

      if (query.length === 0) {
        hideAutocomplete(ledIndex);
        return;
      }

      const matches = searchAirports(query);
      showAutocomplete(ledIndex, matches, input);
    }

    // Search airports
    function searchAirports(query) {
      const q = query.toLowerCase();
      const matches = airportsDatabase.filter(a =>
        a && a.code && a.name && a.city && a.state &&
        (a.code.toLowerCase().includes(q) ||
         a.name.toLowerCase().includes(q) ||
         a.city.toLowerCase().includes(q) ||
         a.state.toLowerCase().includes(q))
      );
      return matches.slice(0, 10);
    }

    // Show autocomplete dropdown
    function showAutocomplete(ledIndex, matches, inputEl) {
      const dropdown = document.querySelector(`.autocomplete-dropdown[data-led="${ledIndex}"]`);

      if (matches.length === 0) {
        dropdown.innerHTML = '<div class="autocomplete-no-results">No airports found</div>';
        dropdown.classList.add('show');
        dropdown.setAttribute('aria-expanded', 'true');
        return;
      }

      dropdown.innerHTML = matches.map((a, idx) => {
        const displayText = `${a.name}, ${a.city}, ${a.state}`;
        const displayName = displayText.length > 50 ? displayText.substring(0, 47) + '...' : displayText;
        const itemId = `autocomplete-led${ledIndex}-item${idx}`;
        return `<div class="autocomplete-item"
                     id="${itemId}"
                     data-code="${a.code}"
                     role="option"
                     aria-selected="false"
                     onclick="selectAirport(${ledIndex}, '${a.code}')">
          <span class="autocomplete-code">${a.code}</span>
          <span class="autocomplete-name">${displayName}</span>
        </div>`;
      }).join('');

      dropdown.classList.add('show');
      dropdown.setAttribute('aria-expanded', 'true');
    }

    // Hide autocomplete dropdown
    function hideAutocomplete(ledIndex) {
      const dropdown = document.querySelector(`.autocomplete-dropdown[data-led="${ledIndex}"]`);
      if (dropdown) {
        dropdown.classList.remove('show');
        dropdown.setAttribute('aria-expanded', 'false');
      }
    }

    // Select airport from autocomplete
    function selectAirport(ledIndex, code) {
      currentConfig.airports[ledIndex] = code;
      const input = document.querySelector(`.airport-input[data-led="${ledIndex}"]`);
      if (input) {
        input.value = code;
      }

      if (wizardActive && wizardState.airports) {
        wizardState.airports[ledIndex] = code;
      }

      hideAutocomplete(ledIndex);
    }

    // Keyboard navigation
    function handleKeyboardNavigation(event) {
      const input = event.target;
      const ledIndex = parseInt(input.dataset.led);
      const dropdown = document.querySelector(`.autocomplete-dropdown[data-led="${ledIndex}"]`);
      const isDropdownOpen = dropdown && dropdown.classList.contains('show');

      const allInputs = Array.from(document.querySelectorAll('.airport-input'));
      const currentIndex = allInputs.indexOf(input);

      if (event.key === 'Tab' && !event.shiftKey) {
        event.preventDefault();
        if (isDropdownOpen) hideAutocomplete(ledIndex);

        if (currentIndex < allInputs.length - 1) {
          const nextInput = allInputs[currentIndex + 1];
          nextInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => nextInput.focus(), 100);
        } else {
          allInputs[0].focus();
        }
      } else if (event.key === 'Tab' && event.shiftKey) {
        event.preventDefault();
        if (isDropdownOpen) hideAutocomplete(ledIndex);

        const prevIndex = currentIndex === 0 ? allInputs.length - 1 : currentIndex - 1;
        allInputs[prevIndex].focus();
      } else if (event.key === 'Enter') {
        event.preventDefault();

        if (isDropdownOpen) {
          const selectedItem = dropdown.querySelector('.autocomplete-item.selected');
          if (selectedItem) {
            const code = selectedItem.dataset.code;
            selectAirport(ledIndex, code);
          }
          hideAutocomplete(ledIndex);
        }

        if (currentIndex < allInputs.length - 1) {
          const nextInput = allInputs[currentIndex + 1];
          nextInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => nextInput.focus(), 100);
        } else {
          allInputs[0].focus();
        }
      } else if (event.key === 'ArrowDown') {
        event.preventDefault();
        if (!isDropdownOpen) {
          handleAutocompleteInput({ target: input });
        } else {
          moveAutocompleteSelection(ledIndex, 'down');
        }
      } else if (event.key === 'ArrowUp' && isDropdownOpen) {
        event.preventDefault();
        moveAutocompleteSelection(ledIndex, 'up');
      } else if (event.key === 'Escape') {
        if (isDropdownOpen) {
          event.preventDefault();
          hideAutocomplete(ledIndex);
          clearAutocompleteSelection(ledIndex);
        }
      }
    }

    function moveAutocompleteSelection(ledIndex, direction) {
      const dropdown = document.querySelector(`.autocomplete-dropdown[data-led="${ledIndex}"]`);
      if (!dropdown) return;

      const items = Array.from(dropdown.querySelectorAll('.autocomplete-item'));
      if (items.length === 0) return;

      let currentIndex = -1;
      items.forEach((item, i) => {
        if (item.classList.contains('selected')) {
          currentIndex = i;
        }
      });

      if (currentIndex >= 0) {
        items[currentIndex].classList.remove('selected');
        items[currentIndex].removeAttribute('aria-selected');
      }

      if (direction === 'down') {
        currentIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
      } else {
        currentIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
      }

      items[currentIndex].classList.add('selected');
      items[currentIndex].setAttribute('aria-selected', 'true');
      items[currentIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });

      const input = document.querySelector(`.airport-input[data-led="${ledIndex}"]`);
      if (input) {
        const itemId = items[currentIndex].id;
        if (itemId) {
          input.setAttribute('aria-activedescendant', itemId);
        }
      }
    }

    function clearAutocompleteSelection(ledIndex) {
      const dropdown = document.querySelector(`.autocomplete-dropdown[data-led="${ledIndex}"]`);
      if (!dropdown) return;

      const items = dropdown.querySelectorAll('.autocomplete-item');
      items.forEach(item => {
        item.classList.remove('selected');
        item.removeAttribute('aria-selected');
      });

      const input = document.querySelector(`.airport-input[data-led="${ledIndex}"]`);
      if (input) {
        input.removeAttribute('aria-activedescendant');
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      document.getElementById('hostname').addEventListener('input', (e) => {
        document.getElementById('hostnamePreview').textContent = e.target.value || 'skyboard';
      });

      document.getElementById('numLeds').addEventListener('change', (e) => {
        const newNum = parseInt(e.target.value);
        if (newNum >= 5 && newNum <= 150 && newNum !== currentConfig.numLeds) {
          currentConfig.numLeds = newNum;
          renderLEDTable();
        }
      });

      document.getElementById('searchBox').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#ledTableBody tr');

        rows.forEach(row => {
          const ledNum = row.querySelector('.led-number').textContent;
          const airportInput = row.querySelector('.airport-input');
          const airportCode = airportInput ? airportInput.value.toLowerCase() : '';

          if (ledNum.includes(query) || airportCode.includes(query)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });

      document.getElementById('saveBtn').addEventListener('click', saveConfiguration);

      // Estimated weather toggle dependency: pulse is disabled when parent is disabled
      function updatePulseToggleState() {
        const useEstimated = document.getElementById('useEstimatedWeather').checked;
        const pulseToggle = document.getElementById('pulseEstimatedWeather');
        pulseToggle.disabled = !useEstimated;
        if (!useEstimated) {
          pulseToggle.checked = false;
        }
      }
      document.getElementById('useEstimatedWeather').addEventListener('change', updatePulseToggleState);
      // Set initial state after config loads
      updatePulseToggleState();

      document.getElementById('importCsvBtn').addEventListener('click', () => {
        document.getElementById('csvFileInput').click();
      });

      document.getElementById('csvFileInput').addEventListener('change', handleCSVImport);
      document.getElementById('exportCsvBtn').addEventListener('click', exportConfigurationAsCSV);

      // Wizard button
      document.getElementById('startWizardBtn').addEventListener('click', async () => {
        try {
          const response = await fetch('/api/v1/config');
          if (!response.ok) throw new Error('Failed to fetch config');
          cachedConfigForWizard = await response.json();
          showWizardStartModal(cachedConfigForWizard.numLeds);
        } catch (error) {
          console.error('Failed to load current config:', error);
          showToast('Failed to load current config. Check ESP8266 connection.', 'error');
        }
      });

      // Wizard modal buttons
      document.getElementById('wizardStartScratchBtn').addEventListener('click', () => {
        hideWizardStartModal();
        startWizard(false);
      });

      document.getElementById('wizardContinueBtn').addEventListener('click', () => {
        hideWizardStartModal();
        startWizard(true);
      });

      document.getElementById('wizardCancelBtn').addEventListener('click', () => {
        hideWizardStartModal();
      });

      document.getElementById('wizardStartModal').addEventListener('click', (e) => {
        if (e.target.id === 'wizardStartModal') {
          hideWizardStartModal();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const modal = document.getElementById('wizardStartModal');
          if (modal && modal.style.display === 'flex') {
            hideWizardStartModal();
          }
        }
      });

      document.getElementById('wizardSaveBtn').addEventListener('click', handleWizardSave);
    }

    // CSV Import
    async function handleCSVImport(e) {
      const file = e.target.files[0];
      if (!file) return;

      e.target.value = '';

      if (!file.name.endsWith('.csv')) {
        showToast('Please select a CSV file', 'error');
        return;
      }

      try {
        const text = await file.text();
        const lines = text.split(/\r?\n/).filter(line => line.trim());

        if (lines.length === 0) {
          showToast('CSV file is empty', 'error');
          return;
        }

        let imported = 0;
        let errors = [];
        const newAirports = [...currentConfig.airports];

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const parts = line.split(',').map(p => p.trim());

          if (parts.length < 2) {
            errors.push(`Line ${i+1}: Invalid format (need index,code)`);
            continue;
          }

          const index = parseInt(parts[0]);
          const code = parts[1].toUpperCase();

          if (isNaN(index)) {
            errors.push(`Line ${i+1}: Invalid index "${parts[0]}"`);
            continue;
          }

          if (index < 0 || index >= 150) {
            errors.push(`Line ${i+1}: Index ${index} out of range (0-149)`);
            continue;
          }

          if (!/^([A-Z0-9]{4}|NONE|BLACK|LIFR|IFR|MVFR|WVFR|VFR)$/.test(code)) {
            errors.push(`Line ${i+1}: Invalid code "${code}"`);
            continue;
          }

          newAirports[index] = code;
          imported++;
        }

        if (imported === 0) {
          showToast('No valid entries found in CSV', 'error');
          if (errors.length > 0) {
            console.error('CSV Import Errors:', errors);
            showToast(`Errors: ${errors.slice(0, 3).join(', ')}`, 'error', 8000);
          }
          return;
        }

        const highestIndex = Math.max(...newAirports.map((code, idx) =>
          (code && code !== 'NONE') ? idx : -1
        ));
        const newNumLeds = Math.max(highestIndex + 1, currentConfig.numLeds);

        currentConfig.airports = newAirports;
        currentConfig.numLeds = newNumLeds;
        document.getElementById('numLeds').value = newNumLeds;

        renderLEDTable();

        if (errors.length > 0) {
          showToast(`Imported ${imported} LEDs with ${errors.length} errors (check console)`, 'warning', 8000);
          console.error('CSV Import Errors:', errors);
        } else {
          showToast(`Successfully imported ${imported} LED assignments`, 'success');
        }

      } catch (error) {
        console.error('CSV import error:', error);
        showToast(`Failed to import CSV: ${error.message}`, 'error');
      }
    }

    // CSV Export
    function exportConfigurationAsCSV() {
      if (!currentConfig || !currentConfig.airports || currentConfig.airports.length === 0) {
        showToast('No LEDs configured to download', 'warning');
        return;
      }

      const csvLines = currentConfig.airports
        .map((code, index) => `${index},${code}`)
        .filter(line => {
          const parts = line.split(',');
          const code = parts[1];
          return code && code !== '' && code !== 'undefined';
        });

      if (csvLines.length === 0) {
        showToast('No LEDs configured to download', 'warning');
        return;
      }

      const csvContent = csvLines.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);

      const date = new Date().toISOString().split('T')[0];
      const filename = `skyboard-config-${date}.csv`;

      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();

      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast(`Configuration exported to ${filename}`, 'success');
    }

    // Save configuration - UPDATED TO USE /api/v1/config POST
    async function saveConfiguration() {
      const numLeds = parseInt(document.getElementById('numLeds').value);
      const brightness = parseInt(document.getElementById('brightnessValue').value);
      const updateIntervalMinutes = parseInt(document.getElementById('updateInterval').value);
      const hostname = document.getElementById('hostname').value.trim() || 'skyboard';
      const useMDNS = document.getElementById('useMDNS').checked;
      const useEstimatedWeather = document.getElementById('useEstimatedWeather').checked;
      const pulseEstimatedWeather = document.getElementById('pulseEstimatedWeather').checked;

      if (numLeds < 1 || numLeds > 150) {
        showToast('Number of LEDs must be between 1 and 150', 'error');
        return;
      }

      if (brightness < 0 || brightness > 255) {
        showToast('Brightness must be between 0 and 255', 'error');
        return;
      }

      if (updateIntervalMinutes < 5 || updateIntervalMinutes > 1440) {
        showToast('Update interval must be between 5 and 1440 minutes', 'error');
        return;
      }

      if (!/^[a-zA-Z0-9-]+$/.test(hostname)) {
        showToast('Hostname can only contain letters, numbers, and hyphens', 'error');
        return;
      }

      if (hostname.length > 32) {
        showToast('Hostname must be 32 characters or less', 'error');
        return;
      }

      if (hostname.startsWith('-') || hostname.endsWith('-')) {
        showToast('Hostname cannot start or end with a hyphen', 'error');
        return;
      }

      // Build airports array-of-objects
      // Schema: [{ledIndex: 0, airportCode: "KSFO"}, ...]
      const airports = [];
      for (let i = 0; i < numLeds; i++) {
        const input = document.querySelector(`.airport-input[data-led="${i}"]`);
        const airportCode = input ? input.value.toUpperCase() : 'NONE';
        airports.push({
          ledIndex: i,
          airportCode: airportCode
        });
      }

      const config = {
        numLeds,
        brightness,
        updateIntervalMinutes,
        hostname,
        useMDNS,
        useEstimatedWeather,
        pulseEstimatedWeather,
        airports
      };

      showLoadingIndicator('Saving configuration...');

      try {
        const response = await fetch('/api/v1/config', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || 'Failed to save configuration');
        }

        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          const data = await response.json();
          if (data.hostnameChanged) {
            hideLoadingIndicator();
            showToast(' ' + data.message + ' New URL: http://' + hostname + '.local', 'warning', 8000);
          } else {
            hideLoadingIndicator();
            showToast('Configuration saved successfully!', 'success');
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          }
        } else {
          hideLoadingIndicator();
          showToast('Configuration saved successfully!', 'success');
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        }

        currentConfig = config;

        showLoadingIndicator('Updating weather data...');
        try {
          const refreshResponse = await fetch('/api/v1/weather/refresh', { method: 'POST' });
          hideLoadingIndicator();
          if (refreshResponse.ok) {
            showToast('Weather data updated successfully!', 'success');
            await loadStatus();
          } else {
            console.warn('Force refresh failed, weather will update on next cycle');
          }
        } catch (refreshError) {
          hideLoadingIndicator();
          console.warn('Force refresh error:', refreshError);
        }

      } catch (error) {
        hideLoadingIndicator();
        showToast('Error saving configuration: ' + error.message, 'error');
      }
    }

    // Wizard localStorage functions
    function saveWizardStateToLocalStorage() {
      if (!wizardActive) return;

      try {
        const stateToSave = {
          numLeds: wizardState.numLeds,
          currentIndex: wizardState.currentIndex,
          airports: wizardState.airports,
          brightness: wizardState.brightness
        };
        localStorage.setItem(WIZARD_STATE_KEY, JSON.stringify(stateToSave));
        localStorage.setItem(WIZARD_STATE_TIMESTAMP_KEY, Date.now().toString());
        console.log('[Wizard] State auto-saved to localStorage:', stateToSave);
      } catch (error) {
        console.error('[Wizard] Failed to save state to localStorage:', error);
      }
    }

    function loadWizardStateFromLocalStorage() {
      try {
        const savedState = localStorage.getItem(WIZARD_STATE_KEY);
        const savedTimestamp = localStorage.getItem(WIZARD_STATE_TIMESTAMP_KEY);

        if (!savedState || !savedTimestamp) return null;

        const age = Date.now() - parseInt(savedTimestamp);
        const MAX_AGE = 24 * 60 * 60 * 1000;

        if (age > MAX_AGE) {
          console.log('[Wizard] Saved state too old, discarding');
          clearWizardStateFromLocalStorage();
          return null;
        }

        const state = JSON.parse(savedState);
        console.log('[Wizard] Recovered state from localStorage:', state);
        return state;
      } catch (error) {
        console.error('[Wizard] Failed to load state from localStorage:', error);
        return null;
      }
    }

    function clearWizardStateFromLocalStorage() {
      localStorage.removeItem(WIZARD_STATE_KEY);
      localStorage.removeItem(WIZARD_STATE_TIMESTAMP_KEY);
      console.log('[Wizard] Cleared saved state from localStorage');
    }

    function checkForCrashedWizardSession() {
      const savedState = loadWizardStateFromLocalStorage();

      if (savedState && savedState.numLeds > 0) {
        const recoveryModal = new Modal();
        const modalContent = document.createElement('div');
        modalContent.innerHTML = `
          <p><strong> Wizard Session Recovery</strong></p>
          <p>We detected an incomplete wizard session with <strong>${savedState.numLeds} LED${savedState.numLeds > 1 ? 's' : ''}</strong> configured.</p>
          <p>Would you like to recover your progress?</p>
          <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button id="recoveryDiscardBtn" class="btn btn-secondary" style="flex: 1;">Discard</button>
            <button id="recoveryRecoverBtn" class="btn" style="flex: 1;"> Recover</button>
          </div>
        `;

        recoveryModal.show('Recover Wizard Session', modalContent);

        document.getElementById('recoveryDiscardBtn').onclick = () => {
          clearWizardStateFromLocalStorage();
          recoveryModal.hide();
          showToast('Wizard session discarded', 'info');
        };

        document.getElementById('recoveryRecoverBtn').onclick = async () => {
          recoveryModal.hide();
          await recoverWizardSession(savedState);
        };
      }
    }

    async function recoverWizardSession(savedState) {
      try {
        showToast('Recovering wizard session...', 'info', 2000);

        const brightness = parseInt(document.getElementById('brightnessValue').value) || savedState.brightness || 20;
        const response = await fetch('/setup/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            startIndex: savedState.currentIndex,
            brightness: brightness
          })
        });

        if (!response.ok) {
          throw new Error('Failed to restart setup mode');
        }

        wizardActive = true;
        wizardState = {
          numLeds: savedState.numLeds,
          currentIndex: savedState.currentIndex,
          airports: savedState.airports,
          brightness: savedState.brightness
        };

        document.getElementById('manualLedConfig').style.display = 'none';
        document.getElementById('wizardContainer').style.display = 'block';
        document.getElementById('startWizardBtn').style.display = 'none';
        document.getElementById('saveBtn').style.display = 'none';

        renderWizardRows();

        const lastInput = document.getElementById(`wizard-input-${wizardState.currentIndex}`);
        if (lastInput) {
          lastInput.focus();
        }

        showToast(` Recovered ${savedState.numLeds} LED${savedState.numLeds > 1 ? 's' : ''}! Continue where you left off.`, 'success', 5000);
      } catch (error) {
        console.error('[Wizard] Recovery failed:', error);
        showToast('Recovery failed. Starting fresh wizard session.', 'error');
        clearWizardStateFromLocalStorage();
      }
    }

    function showWizardStartModal(numLeds) {
      const modal = document.getElementById('wizardStartModal');
      const ledCountText = document.getElementById('wizardModalLedCount');
      const continueLedCount = document.getElementById('wizardContinueLedCount');

      ledCountText.innerHTML = `You currently have <strong>${numLeds} LED${numLeds !== 1 ? 's' : ''}</strong> configured.`;
      continueLedCount.textContent = numLeds;

      modal.style.display = 'flex';
    }

    function hideWizardStartModal() {
      const modal = document.getElementById('wizardStartModal');
      modal.style.display = 'none';
    }

    async function startWizard(continueFromExisting = false) {
      try {
        const brightness = parseInt(document.getElementById('brightnessValue').value) || 20;
        const startIndex = (continueFromExisting && cachedConfigForWizard) ? cachedConfigForWizard.numLeds : 0;

        if (continueFromExisting && cachedConfigForWizard && cachedConfigForWizard.numLeds > 150) {
          showToast('Cannot start wizard: too many LEDs (max 150)', 'error');
          return;
        }

        const response = await fetch('/setup/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            startIndex: startIndex,
            brightness: brightness
          })
        });

        if (!response.ok) {
          throw new Error('Failed to start setup mode');
        }

        const result = await response.json();

        wizardActive = true;
        if (continueFromExisting && cachedConfigForWizard) {
          wizardState = {
            numLeds: cachedConfigForWizard.numLeds + 1,
            currentIndex: cachedConfigForWizard.numLeds,
            airports: [...cachedConfigForWizard.airports.slice(0, cachedConfigForWizard.numLeds), ''],
            brightness: brightness
          };
        } else {
          wizardState = {
            numLeds: 1,
            currentIndex: 0,
            airports: [''],
            brightness: brightness
          };
        }

        saveWizardStateToLocalStorage();

        document.getElementById('manualLedConfig').style.display = 'none';
        document.getElementById('wizardContainer').style.display = 'block';
        document.getElementById('startWizardBtn').style.display = 'none';
        document.getElementById('saveBtn').style.display = 'none';

        renderWizardRows();

        if (continueFromExisting) {
          showToast(`Wizard started! Continuing from ${cachedConfigForWizard.numLeds} LEDs. LED ${cachedConfigForWizard.numLeds} is blinking orange.`, 'success');
        } else {
          showToast('Wizard started! LED 0 is blinking orange.', 'success');
        }
      } catch (error) {
        console.error('Failed to start wizard:', error);
        showToast('Failed to start wizard. Check ESP8266 connection.', 'error');
      }
    }

    function renderWizardRows() {
      const container = document.getElementById('wizardRows');
      container.innerHTML = '';

      for (let i = 0; i < wizardState.numLeds; i++) {
        const row = createWizardRow(i);
        container.appendChild(row);
      }

      // Reinitialize Lucide icons
      lucide.createIcons();
    }

    function createWizardRow(ledIndex) {
      const row = document.createElement('div');
      row.className = 'wizard-row';
      row.id = `wizard-row-${ledIndex}`;

      const label = document.createElement('span');
      label.className = 'wizard-led-label';
      label.textContent = `LED ${ledIndex}`;

      const inputWrapper = document.createElement('div');
      inputWrapper.className = 'airport-input-wrapper';

      const input = document.createElement('input');
      input.type = 'text';
      input.id = `wizard-input-${ledIndex}`;
      input.className = 'wizard-input airport-input';
      input.dataset.led = ledIndex;
      input.placeholder = 'Type to search...';
      input.value = wizardState.airports[ledIndex] || '';
      input.autocomplete = 'off';
      input.autocapitalize = 'characters';
      input.setAttribute('aria-label', `LED ${ledIndex} airport code`);
      input.setAttribute('aria-autocomplete', 'list');
      input.setAttribute('aria-controls', `wizard-autocomplete-${ledIndex}`);
      input.setAttribute('role', 'combobox');
      input.setAttribute('aria-expanded', 'false');

      const dropdown = document.createElement('div');
      dropdown.className = 'autocomplete-dropdown';
      dropdown.dataset.led = ledIndex;
      dropdown.id = `wizard-autocomplete-${ledIndex}`;
      dropdown.setAttribute('role', 'listbox');
      dropdown.setAttribute('aria-expanded', 'false');

      inputWrapper.appendChild(input);
      inputWrapper.appendChild(dropdown);

      input.addEventListener('input', (e) => {
        wizardState.airports[ledIndex] = e.target.value.trim().toUpperCase();
        handleAutocompleteInput(e);
        saveWizardStateToLocalStorage();
      });

      input.addEventListener('focus', handleAutocompleteInput);
      input.addEventListener('blur', (e) => {
        setTimeout(() => hideAutocomplete(ledIndex), 200);
      });
      input.addEventListener('keydown', handleKeyboardNavigation);

      const nextBtn = document.createElement('button');
      nextBtn.className = 'wizard-next-btn';
      nextBtn.textContent = 'Next';
      nextBtn.dataset.led = ledIndex;

      if (ledIndex !== wizardState.numLeds - 1) {
        nextBtn.disabled = true;
        nextBtn.style.opacity = '0.3';
        nextBtn.textContent = '';
      } else {
        nextBtn.addEventListener('click', () => handleWizardNext(ledIndex));
      }

      row.appendChild(label);
      row.appendChild(inputWrapper);
      row.appendChild(nextBtn);

      return row;
    }

    async function handleWizardNext(ledIndex) {
      const input = document.getElementById(`wizard-input-${ledIndex}`);
      const value = input.value.trim().toUpperCase();

      if (!value) {
        showToast('Please enter an airport code or "NONE"', 'error');
        input.focus();
        return;
      }

      if (!/^([A-Z0-9]{4}|NONE|BLACK)$/.test(value)) {
        showToast('Invalid airport code. Use 4-character ICAO code (e.g., K1B9) or "NONE".', 'error', 8000);
        input.focus();
        return;
      }

      try {
        wizardState.airports[ledIndex] = value;
        wizardState.numLeds += 1;
        wizardState.currentIndex = wizardState.numLeds - 1;
        wizardState.airports[wizardState.currentIndex] = '';

        saveWizardStateToLocalStorage();

        const response = await fetch('/setup/next', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            nextIndex: wizardState.currentIndex
          })
        });

        if (!response.ok) {
          throw new Error('Failed to update LED index');
        }

        renderWizardRows();

        const newInput = document.getElementById(`wizard-input-${wizardState.currentIndex}`);
        if (newInput) {
          newInput.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
          setTimeout(() => newInput.focus(), 300);
        }

        showToast(`LED ${ledIndex} configured. LED ${wizardState.currentIndex} is now blinking.`, 'success');
      } catch (error) {
        console.error('Failed to add next LED:', error);
        showToast('Failed to update. Check ESP8266 connection.', 'error');

        wizardState.numLeds -= 1;
        wizardState.currentIndex = wizardState.numLeds - 1;
        wizardState.airports.pop();
        saveWizardStateToLocalStorage();
      }
    }

    async function handleWizardSave() {
      // Filter out any blank LED fields from the end of the array
      let validAirports = [...wizardState.airports];

      // Update values from input fields first
      for (let i = 0; i < wizardState.numLeds; i++) {
        const input = document.getElementById(`wizard-input-${i}`);
        if (input) {
          const value = input.value.trim().toUpperCase();
          validAirports[i] = value;
        }
      }

      // Filter out blank entries from the end
      while (validAirports.length > 0 && !validAirports[validAirports.length - 1]) {
        validAirports.pop();
      }

      // Validate remaining non-blank entries
      for (let i = 0; i < validAirports.length; i++) {
        const value = validAirports[i];
        if (value && !/^([A-Z0-9]{4}|NONE|BLACK)$/.test(value)) {
          showToast(`Invalid airport code on LED ${i}. Use 4-character ICAO code (e.g., K1B9) or "NONE".`, 'error', 8000);
          const input = document.getElementById(`wizard-input-${i}`);
          if (input) input.focus();
          return;
        }
      }

      // Update wizard state with filtered airports
      wizardState.airports = validAirports;
      wizardState.numLeds = validAirports.length;

      const confirmModal = new Modal();
      const modalContent = document.createElement('div');
      modalContent.innerHTML = `
        <p>Are you sure you want to save this configuration?</p>
        <p style="margin-top: 16px;"><strong>You have configured ${wizardState.numLeds} LED${wizardState.numLeds > 1 ? 's' : ''}.</strong></p>
        <div style="display: flex; gap: 12px; margin-top: 24px;">
          <button id="modalCancelBtn" class="btn btn-secondary" style="flex: 1;">No, Continue</button>
          <button id="modalConfirmBtn" class="btn btn-success" style="flex: 1;">Yes, Save</button>
        </div>
      `;

      confirmModal.show('Confirm Save', modalContent);

      document.getElementById('modalCancelBtn').onclick = () => confirmModal.hide();
      document.getElementById('modalConfirmBtn').onclick = async () => {
        confirmModal.hide();
        await saveWizardConfig();
      };

      // Reinitialize Lucide icons in modal
      lucide.createIcons();
    }

    async function saveWizardConfig() {
      try {
        const fullAirports = new Array(150).fill('NONE');
        for (let i = 0; i < wizardState.numLeds; i++) {
          fullAirports[i] = wizardState.airports[i] || 'NONE';
        }

        const finalConfig = {
          numLeds: wizardState.numLeds,
          airports: fullAirports,
          brightness: wizardState.brightness,
          hostname: document.getElementById('hostname').value.trim(),
          useMDNS: document.getElementById('useMDNS').checked,
          updateIntervalMinutes: parseInt(document.getElementById('updateInterval').value)
        };

        // Stop wizard LED mode first
        const stopResponse = await fetch('/setup/stop', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!stopResponse.ok) {
          throw new Error('Failed to stop wizard mode');
        }

        // Save configuration
        const saveResponse = await fetch('/api/v1/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(finalConfig)
        });

        if (!saveResponse.ok) {
          throw new Error('Failed to save configuration');
        }

        showToast(`Configuration saved! ${wizardState.numLeds} LEDs configured.`, 'success', 5000);

        clearWizardStateFromLocalStorage();

        exitWizard();

        setTimeout(() => {
          loadConfig();
        }, 1000);
      } catch (error) {
        console.error('Failed to save wizard config:', error);
        showToast('Failed to save configuration. Check ESP32 connection.', 'error');
      }
    }

    function exitWizard() {
      wizardActive = false;
      wizardState = {
        numLeds: 0,
        currentIndex: 0,
        airports: [],
        brightness: 20
      };

      clearWizardStateFromLocalStorage();

      document.getElementById('wizardContainer').style.display = 'none';
      document.getElementById('manualLedConfig').style.display = 'block';
      document.getElementById('startWizardBtn').style.display = 'inline-block';
      document.getElementById('saveBtn').style.display = 'block';

      document.getElementById('wizardRows').innerHTML = '';
    }

    window.addEventListener('beforeunload', (e) => {
      if (wizardActive) {
        e.preventDefault();
        e.returnValue = 'You have an active wizard session. Progress will be lost if you leave.';
        return e.returnValue;
      }
    });

    // Toast functions
    function showToast(message, type = 'success', duration = null) {
      const toast = document.getElementById('toast');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');

      if (!toast) {
        console.error('Toast element not found');
        return;
      }

      toastTitle.textContent = '';
      toastMessage.textContent = message;

      toast.className = `toast ${type}`;
      toast.classList.add('show');

      if (toastTimeoutId) {
        clearTimeout(toastTimeoutId);
      }

      if (!duration) {
        duration = type === 'error' ? 7000 : 5000;
      }

      toastTimeoutId = setTimeout(() => {
        hideToast();
      }, duration);
    }

    function hideToast() {
      const toast = document.getElementById('toast');
      if (toast) {
        toast.classList.remove('show');
      }
      if (toastTimeoutId) {
        clearTimeout(toastTimeoutId);
        toastTimeoutId = null;
      }
    }

    // Loading indicator
    let loadingOverlay = null;

    function showLoadingIndicator(message = 'Loading...') {
      if (!loadingOverlay) {
        loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'loading-overlay';
        loadingOverlay.innerHTML = `
          <div class="loading-spinner"></div>
          <div class="loading-text">${message}</div>
        `;
        document.body.appendChild(loadingOverlay);
      } else {
        loadingOverlay.querySelector('.loading-text').textContent = message;
        loadingOverlay.style.display = 'flex';
      }
    }

    function hideLoadingIndicator() {
      if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
      }
    }

    // Modal class
    class Modal {
      constructor() {
        this.overlay = null;
        this.modal = null;
        this.onCloseCallback = null;
      }

      show(title, content, onClose = null) {
        this.onCloseCallback = onClose;

        this.overlay = document.createElement('div');
        this.overlay.className = 'modal-overlay';
        this.overlay.setAttribute('role', 'dialog');
        this.overlay.setAttribute('aria-modal', 'true');
        this.overlay.setAttribute('aria-labelledby', 'modal-title');

        this.modal = document.createElement('div');
        this.modal.className = 'modal-box';

        const header = document.createElement('div');
        header.style.marginBottom = '16px';

        const titleEl = document.createElement('h2');
        titleEl.id = 'modal-title';
        titleEl.textContent = title;
        titleEl.style.margin = '0';
        titleEl.style.fontSize = '24px';
        titleEl.style.fontWeight = '700';

        header.appendChild(titleEl);

        const body = document.createElement('div');
        if (typeof content === 'string') {
          body.innerHTML = content;
        } else {
          body.appendChild(content);
        }

        this.modal.appendChild(header);
        this.modal.appendChild(body);
        this.overlay.appendChild(this.modal);

        document.body.appendChild(this.overlay);

        this.overlay.onclick = (e) => {
          if (e.target === this.overlay) this.hide();
        };

        document.addEventListener('keydown', this.handleEscape);

        this.modal.setAttribute('tabindex', '-1');
        this.modal.focus();

        // Initialize Lucide icons in modal
        lucide.createIcons();
      }

      hide() {
        if (this.overlay && this.overlay.parentNode) {
          this.overlay.parentNode.removeChild(this.overlay);
        }
        document.removeEventListener('keydown', this.handleEscape);
        if (this.onCloseCallback) {
          this.onCloseCallback();
        }
        this.overlay = null;
        this.modal = null;
      }

      handleEscape = (e) => {
        if (e.key === 'Escape') {
          this.hide();
        }
      }
    }

    // Theme toggle
    window.toggleTheme = function() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);

      const icon = document.getElementById('themeIcon');
      icon.setAttribute('data-lucide', newTheme === 'dark' ? 'moon' : 'sun');
      lucide.createIcons();

      localStorage.setItem('theme', newTheme);
    };

    // Mobile menu toggle
    window.toggleMenu = function() {
      document.getElementById('navMenu').classList.toggle('open');
    };

    // Load saved theme
    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      const icon = document.getElementById('themeIcon');
      icon.setAttribute('data-lucide', savedTheme === 'dark' ? 'moon' : 'sun');
      lucide.createIcons();
    });

    // ===== WIFI CONFIGURATION =====

    let availableNetworks = [];
    let selectedNetwork = null;
    let testConnectionPassed = false;

    async function loadWiFiInfo() {
      try {
        const response = await fetch('/api/v1/config');
        if (!response.ok) throw new Error('Failed to fetch config');

        const data = await response.json();

        // Update current WiFi info
        document.getElementById('wifiCurrentSSID').textContent = data.wifi_ssid || 'Not configured';
        document.getElementById('wifiCurrentIP').textContent = data.ip || '--';
        document.getElementById('wifiCurrentRSSI').textContent = data.wifi_rssi ? `${data.wifi_rssi} dBm` : '--';
        document.getElementById('wifiCurrentMAC').textContent = data.mac || '--';

      } catch (error) {
        console.error('Failed to load WiFi info:', error);
      }
    }

    async function showNetworkSelector() {
      const modal = document.getElementById('networkSelectorModal');
      modal.classList.remove('hidden');

      // Reset state
      selectedNetwork = null;
      testConnectionPassed = false;
      document.getElementById('saveNetworkBtn').disabled = true;
      document.getElementById('networkCredentials').classList.add('hidden');

      // Start network scan
      await scanNetworks();
    }

    function hideNetworkSelector() {
      const modal = document.getElementById('networkSelectorModal');
      modal.classList.add('hidden');
    }

    async function scanNetworks() {
      const scanning = document.getElementById('networkScanning');
      const list = document.getElementById('networkList');

      scanning.classList.remove('hidden');
      list.classList.add('hidden');
      list.innerHTML = '';

      try {
        const response = await fetch('/api/v1/wifi/networks');
        if (!response.ok) throw new Error('Failed to scan networks');

        const networks = await response.json();
        availableNetworks = networks;

        scanning.classList.add('hidden');
        list.classList.remove('hidden');

        if (networks.length === 0) {
          list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No networks found</p>';
          return;
        }

        networks.forEach(network => {
          const item = document.createElement('div');
          item.className = 'network-item';
          item.onclick = () => selectNetwork(network);

          const signalBars = rssiToBars(network.rssi);

          item.innerHTML = `
            <div class="network-ssid">
              <i data-lucide="wifi"></i>
              <span>${network.ssid}</span>
              ${network.encryption !== 0 ? '<i data-lucide="lock" style="width: 14px; height: 14px;"></i>' : ''}
            </div>
            <div class="network-rssi">${signalBars} ${network.rssi} dBm</div>
          `;

          list.appendChild(item);
        });

        // Reinitialize Lucide icons
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }

      } catch (error) {
        console.error('Network scan failed:', error);
        scanning.classList.add('hidden');
        list.classList.remove('hidden');
        list.innerHTML = '<p style="text-align: center; color: var(--error); padding: 20px;">Scan failed. Try again.</p>';
      }
    }

    function rssiToBars(rssi) {
      if (rssi > -50) return '';
      if (rssi > -60) return '_';
      if (rssi > -70) return '__';
      return '___';
    }

    function selectNetwork(network) {
      selectedNetwork = network;
      testConnectionPassed = false;

      // Update UI
      const items = document.querySelectorAll('.network-item');
      items.forEach(item => item.classList.remove('selected'));
      event.currentTarget.classList.add('selected');

      // Show credentials form
      document.getElementById('selectedSSID').value = network.ssid;
      document.getElementById('wifiPassword').value = '';
      document.getElementById('networkCredentials').classList.remove('hidden');
      document.getElementById('testResult').textContent = '';
      document.getElementById('saveNetworkBtn').disabled = true;
    }

    function togglePasswordVisibility() {
      const input = document.getElementById('wifiPassword');
      const icon = document.getElementById('passwordToggleIcon');

      if (input.type === 'password') {
        input.type = 'text';
        icon.setAttribute('data-lucide', 'eye-off');
      } else {
        input.type = 'password';
        icon.setAttribute('data-lucide', 'eye');
      }

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    async function testWiFiConnection() {
      if (!selectedNetwork) {
        showTestConnectionModal('Error', 'No network selected', 'error');
        return;
      }

      const password = document.getElementById('wifiPassword').value;
      const resultSpan = document.getElementById('testResult');
      const saveBtn = document.getElementById('saveNetworkBtn');

      resultSpan.textContent = 'Testing...';
      resultSpan.className = 'test-result';
      saveBtn.disabled = true;

      try {
        const response = await fetch('/api/v1/wifi/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ssid: selectedNetwork.ssid,
            pass: password
          })
        });

        const data = await response.json();

        if (data.success) {
          testConnectionPassed = true;
          resultSpan.textContent = ' Connection successful!';
          resultSpan.className = 'test-result success';
          saveBtn.disabled = false;
          showTestConnectionModal('Success', 'Connection test passed! You can now save this configuration.', 'success');
        } else {
          testConnectionPassed = false;
          resultSpan.textContent = ' Connection failed';
          resultSpan.className = 'test-result error';
          saveBtn.disabled = true;
          showTestConnectionModal('Test Failed', data.message || 'Could not connect to network. Check password and try again.', 'error');
        }

      } catch (error) {
        console.error('Test connection failed:', error);
        testConnectionPassed = false;
        resultSpan.textContent = ' Test error';
        resultSpan.className = 'test-result error';
        saveBtn.disabled = true;
        showTestConnectionModal('Error', 'Test failed: ' + error.message, 'error');
      }
    }

    function showTestConnectionModal(title, message, type) {
      // Reuse existing modal system or create simple alert
      const modal = `
        <div class="modal" id="testModal" style="display: flex;">
          <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
              <h3>${title}</h3>
              <button class="modal-close" onclick="closeTestModal()">&times;</button>
            </div>
            <div class="modal-body">
              <p>${message}</p>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" onclick="closeTestModal()">OK</button>
            </div>
          </div>
        </div>
      `;

      const existing = document.getElementById('testModal');
      if (existing) existing.remove();

      document.body.insertAdjacentHTML('beforeend', modal);

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    function closeTestModal() {
      const modal = document.getElementById('testModal');
      if (modal) modal.remove();
    }

    async function saveWiFiConfig() {
      if (!testConnectionPassed) {
        showTestConnectionModal('Error', 'Please test the connection first before saving.', 'error');
        return;
      }

      const password = document.getElementById('wifiPassword').value;
      const currentConfig = await fetchCurrentConfig();

      const newConfig = {
        ...currentConfig,
        wifi_ssid: selectedNetwork.ssid,
        wifi_pass: password
      };

      try {
        const response = await fetch('/api/v1/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newConfig)
        });

        const data = await response.json();

        if (data.success) {
          showTestConnectionModal('Success', 'WiFi configuration saved! Device will reboot to apply changes.', 'success');
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        } else {
          showTestConnectionModal('Error', data.message || 'Failed to save configuration', 'error');
        }

      } catch (error) {
        console.error('Save WiFi config failed:', error);
        showTestConnectionModal('Error', 'Failed to save: ' + error.message, 'error');
      }
    }

    async function fetchCurrentConfig() {
      const response = await fetch('/api/v1/config');
      return await response.json();
    }

    async function refreshNetworkScan() {
      await scanNetworks();
    }

    // Load WiFi info on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadWiFiInfo();
    });

    // Global error handler
    window.addEventListener('error', (event) => {
      console.error('Global error caught:', event.error);
      hideLoadingIndicator();
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      hideLoadingIndicator();
    });
  </script>
</body>
</html>
